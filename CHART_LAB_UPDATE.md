# 图表实验室更新说明

## 🎉 更新内容

### 1. 依赖问题修复
- **问题**: `openpyxl` 版本 2.4.11 不满足 pandas 要求 (需要 ≥3.1.0)
- **解决**: 升级 `openpyxl` 到 3.1.5
- **影响**: 解决了 `/api/charts/inspect/` 返回 400 错误的问题

### 2. 页面风格优化
完全重构图表实验室页面，使其与其他页面风格保持一致：

#### 视觉设计优化
- ✨ 采用卡片式布局，与任务创建页面风格统一
- 🎨 使用渐变色标题和图标，增强视觉层次
- 📦 添加分组配置区块，提升内容组织性
- 🎯 优化表格样式，表头使用主题色高亮
- 💫 添加悬停动画效果，提升交互体验

#### 布局改进
- 📋 采用三步骤流程：上传预览 → 配置 → 结果
- 🔲 使用 `section-header` 统一各区块标题样式
- 📊 配置项按功能分组：基本设置、数据聚合、样式设置、过滤条件
- 📱 响应式设计，适配移动端显示

#### 交互增强
- 🏷️ 过滤条件标签添加图标和删除按钮
- 📈 统计卡片添加渐变背景和图标
- ⚠️ 警告提示框优化布局和图标显示
- 🎨 汇总信息栏采用渐变色背景

#### 功能细节
- 表单标签添加图标，提升可读性
- 多选框添加提示文字
- 空状态提示优化，使用大图标和说明文字
- 按钮分组和间距调整

### 3. JavaScript 优化
更新前端交互逻辑以匹配新的 HTML 结构：

```javascript
// 更新内容：
- renderFilters(): 添加图标和优化空状态提示
- updateSummary(): 汇总信息添加图标
- renderStatistics(): 统计卡片样式优化
- showWarnings(): 警告信息布局改进
- renderChartResult(): 图表结果展示优化
```

## 🚀 使用指南

### 访问入口
- 导航栏点击 **图表实验室** 或直接访问 `/charts/lab/`

### 操作流程

#### 步骤 1: 数据上传与预览
1. 选择 Excel/CSV/JSON 文件
2. 可选：指定工作表名称（Excel）
3. 设置预览行数（5-200）
4. 点击"生成数据预览"

**预览内容：**
- 数据汇总：总行数、列数量、数值列数
- 数据表格：前 N 行数据
- 基础统计：数值列的描述性统计

#### 步骤 2: 图表配置

**基本设置：**
- 图表类型：柱状图、折线图、散点图等
- X 轴字段：选择横轴数据
- Y 轴字段：选择纵轴数据（可多选）

**数据聚合（可选）：**
- 分组字段：按某些列分组（可多选）
- 聚合方式：求和、平均值、计数等

**样式设置：**
- 图表标题、X/Y 轴名称
- 图表尺寸（宽度、高度）
- X 轴刻度角度
- 显示网格、显示图例

**数据过滤（可选）：**
- 选择字段、条件和值
- 支持多个过滤条件叠加
- 点击标签上的 ✕ 删除条件

#### 步骤 3: 生成与查看
1. 点击"生成图表"按钮
2. 等待图表渲染（显示加载动画）
3. 查看生成的图表和统计信息

## 📊 测试数据

已创建测试文件：`d:/桌面/excel_work/test_data.xlsx`

**测试数据内容：**
```
城市    人口(万)  GDP(亿元)
北京    2154     40269
上海    2428     43214
广州    1868     28231
深圳    1756     30665
杭州    1220     18753
```

## 🎨 样式特点

### 配色方案
- 主色调：使用项目统一的 `--primary-color` 和 `--primary-light`
- 卡片背景：`--card-bg` (支持深色模式)
- 渐变效果：统一使用 135deg 线性渐变

### 组件样式
- **section-header**: 区块标题，带图标和渐变色
- **config-section**: 配置区块，浅色背景区分
- **summary-bar**: 汇总信息栏，渐变背景
- **filter-badge**: 过滤标签，主题色背景
- **stat-card**: 统计卡片，悬停效果

## 🔧 技术细节

### 前端技术栈
- HTML5 + Django Templates
- CSS3 (变量、渐变、动画)
- JavaScript (ES6+)
- Font Awesome 图标

### 后端 API
- `/api/charts/inspect/`: 数据预览接口
- `/api/charts/custom/`: 图表生成接口

### 依赖库
- pandas >= 2.0.0
- numpy >= 1.24.0
- matplotlib >= 3.7.0
- openpyxl >= 3.1.0

## 📝 注意事项

1. **文件大小限制**: 预览最多 50,000 行数据
2. **图表类型限制**:
   - 散点图：只支持单个 Y 轴字段
   - 饼图：只支持单个数值字段
3. **数据聚合**: 选择分组字段后，Y 轴数据会自动聚合
4. **过滤条件**: 使用 `in` 或 `not_in` 时，多个值用逗号分隔

## 🐛 问题排查

### 如果页面无法加载
```bash
# 检查模板语法
python manage.py shell -c "from django.test import Client; c=Client(); r=c.get('/charts/lab/', HTTP_HOST='localhost'); print(r.status_code)"
```

### 如果 API 返回 400
```bash
# 检查 openpyxl 版本
python -c "import openpyxl; print(openpyxl.__version__)"

# 应该显示 >= 3.1.0
```

### 如果样式显示异常
1. 清除浏览器缓存
2. 检查 `{% load static %}` 是否存在
3. 确认 CSS 变量已定义（在 base.html 中）

## 🎯 下一步优化建议

1. **性能优化**
   - 大文件异步处理
   - 图表缓存机制
   - 进度条显示

2. **功能增强**
   - 支持更多图表类型（热力图、雷达图等）
   - 图表导出功能（PNG、SVG、PDF）
   - 配置保存和加载
   - 图表对比功能

3. **用户体验**
   - 拖拽上传优化
   - 配置预设模板
   - 实时预览功能
   - 移动端手势支持

## 📚 相关文件

- 模板: `merger/templates/merger/chart_lab.html`
- 样式: 内联在模板的 `extra_css` 块中
- 脚本: `merger/static/js/chart_lab.js`
- 视图: `merger/views.py` (chart_lab, api_custom_chart_inspect, api_generate_custom_chart)
- 路由: `merger/urls.py`
- 依赖: `requirements.txt`

---

**更新日期**: 2025年10月20日  
**版本**: v3.1  
**作者**: GitHub Copilot
