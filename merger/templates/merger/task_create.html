{% extends 'base.html' %}

{% block title %}åˆ›å»ºä»»åŠ¡ - Excel åˆå¹¶å·¥å…·{% endblock %}

{% block content %}
<div class="page-header">
    <h1>åˆ›å»ºåˆå¹¶ä»»åŠ¡</h1>
    <p>æŒ‰ç…§æ­¥éª¤é…ç½®æ‚¨çš„Excelåˆå¹¶ä»»åŠ¡</p>
</div>

<div class="wizard">
    <div class="wizard-steps">
        <div class="wizard-step active" data-step="1">
            <div class="step-indicator">1</div>
            <span>åŸºæœ¬ä¿¡æ¯</span>
        </div>
        <div class="wizard-step" data-step="2">
            <div class="step-indicator">2</div>
            <span>ä¸Šä¼ æ–‡ä»¶</span>
        </div>
        <div class="wizard-step" data-step="3">
            <div class="step-indicator">3</div>
            <span>åˆ—è§„åˆ™(å¯é€‰)</span>
        </div>
        <div class="wizard-step" data-step="4">
            <div class="step-indicator">4</div>
            <span>å•å…ƒæ ¼æ“ä½œ(å¯é€‰)</span>
        </div>
        <div class="wizard-step" data-step="5">
            <div class="step-indicator">5</div>
            <span>åˆ—è¿‡æ»¤(å¯é€‰)</span>
        </div>
        <div class="wizard-step" data-step="6">
            <div class="step-indicator">6</div>
            <span>æ‰§è¡Œå¤„ç†</span>
        </div>
    </div>

    <div class="wizard-content">
        <!-- æ­¥éª¤ 1: åŸºæœ¬ä¿¡æ¯ -->
        <div class="wizard-panel active" data-panel="1">
            <h2>ç¬¬ä¸€æ­¥:åŸºæœ¬ä¿¡æ¯</h2>
            <div class="form-group">
                <label for="task-name">ä»»åŠ¡åç§° *</label>
                <input type="text" id="task-name" class="form-control" placeholder="ä¾‹å¦‚:2024å­¦ç”Ÿä¿¡æ¯åˆå¹¶" required>
            </div>
            <div class="form-group">
                <label for="output-format">è¾“å‡ºæ ¼å¼ *</label>
                <select id="output-format" class="form-control">
                    <option value="xlsx">XLSX (æ¨è,æ”¯æŒå›¾ç‰‡)</option>
                    <option value="xls">XLS (Excel 2003 å…¼å®¹)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="filter-mode">åˆ—è¿‡æ»¤æ¨¡å¼</label>
                <select id="filter-mode" class="form-control" onchange="toggleFilterColumns()">
                    <option value="none">ä¸è¿‡æ»¤åˆ—</option>
                    <option value="keep">åªä¿ç•™æŒ‡å®šåˆ—</option>
                    <option value="remove">åˆ é™¤æŒ‡å®šåˆ—</option>
                </select>
            </div>
            
            <div id="filter-columns-form" style="display:none">
                <div class="form-group">
                    <label for="filter-columns">åˆ—ååˆ—è¡¨ (æ¯è¡Œä¸€ä¸ª)</label>
                    <textarea id="filter-columns" class="form-control" rows="5" placeholder="ä¾‹å¦‚:&#10;å§“å&#10;å­¦å·&#10;æˆç»©"></textarea>
                    <small class="form-hint">è¾“å…¥è¦ä¿ç•™æˆ–åˆ é™¤çš„åˆ—å,æ¯è¡Œä¸€ä¸ªåˆ—å</small>
                </div>
            </div>
            
            <div class="wizard-actions">
                <button type="button" class="btn btn-primary" onclick="createTask()">ä¸‹ä¸€æ­¥</button>
            </div>
        </div>

        <!-- æ­¥éª¤ 2: ä¸Šä¼ æ–‡ä»¶ -->
        <div class="wizard-panel" data-panel="2">
            <h2>ç¬¬äºŒæ­¥:ä¸Šä¼ æ–‡ä»¶</h2>
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">ğŸ“¤</div>
                <p>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
                <p class="upload-hint">æ”¯æŒ .xlsx æ ¼å¼,å¯ä¸€æ¬¡ä¸Šä¼ å¤šä¸ªæ–‡ä»¶</p>
                <input type="file" id="file-input" multiple accept=".xlsx" style="display:none">
            </div>
            <div class="file-list" id="file-list"></div>
            <div class="wizard-actions">
                <button type="button" class="btn btn-secondary" onclick="previousStep()">ä¸Šä¸€æ­¥</button>
                <button type="button" class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
            </div>
        </div>

        <!-- æ­¥éª¤ 3: åˆ—è§„åˆ™ -->
        <div class="wizard-panel" data-panel="3">
            <h2>ç¬¬ä¸‰æ­¥:åˆ—æ´¾ç”Ÿè§„åˆ™(å¯é€‰)</h2>
            <p class="panel-hint">æ ¹æ®ç°æœ‰åˆ—çš„å†…å®¹åˆ›å»ºæ–°åˆ—,ä¾‹å¦‚ä»å­¦å·ä¸­æå–ç­çº§ä¿¡æ¯</p>
            
            <!-- åŠŸèƒ½è¯´æ˜ -->
            <div class="help-box">
                <h4>ğŸ“– åŠŸèƒ½è¯´æ˜</h4>
                <p><strong>ä»€ä¹ˆæ˜¯åˆ—æ´¾ç”Ÿ?</strong></p>
                <p>ä»å·²æœ‰åˆ—ä¸­æå–æˆ–è½¬æ¢ä¿¡æ¯,è‡ªåŠ¨ç”Ÿæˆæ–°åˆ—ã€‚å¸¸è§åº”ç”¨:</p>
                <ul>
                    <li>ä»å­¦å· "202401001" ä¸­æå–ç­çº§ "01" â†’ è½¬æ¢ä¸º "ä¸€ç­"</li>
                    <li>ä»èº«ä»½è¯å·æå–å‡ºç”Ÿå¹´ä»½æˆ–æ€§åˆ«ä¿¡æ¯</li>
                    <li>ä»å•†å“ç¼–ç æå–ç±»åˆ«ä»£ç å¹¶è½¬æ¢ä¸ºç±»åˆ«åç§°</li>
                </ul>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="enable-column-rule" onchange="toggleColumnRule()"> å¯ç”¨åˆ—æ´¾ç”Ÿè§„åˆ™
                </label>
            </div>

            <div id="column-rule-form" style="display:none">
                <!-- ç¬¬ä¸€æ­¥:é€‰æ‹©æºåˆ—å’Œæ–°åˆ—å -->
                <div class="config-section">
                    <h4>1ï¸âƒ£ åŸºæœ¬é…ç½®</h4>
                    <div class="form-group">
                        <label for="source-column">æºåˆ—å * <span class="help-text">è¦ä»å“ªä¸€åˆ—æå–ä¿¡æ¯?</span></label>
                        <input type="text" id="source-column" class="form-control" placeholder="ä¾‹å¦‚:å­¦å·">
                        <small class="form-hint">ğŸ’¡ è¾“å…¥Excelè¡¨æ ¼ä¸­å·²å­˜åœ¨çš„åˆ—å,å¿…é¡»å®Œå…¨åŒ¹é…</small>
                    </div>
                    <div class="form-group">
                        <label for="new-column">æ–°åˆ—å * <span class="help-text">ç”Ÿæˆçš„æ–°åˆ—å«ä»€ä¹ˆåå­—?</span></label>
                        <input type="text" id="new-column" class="form-control" placeholder="ä¾‹å¦‚:ç­çº§">
                        <small class="form-hint">ğŸ’¡ è¿™ä¸ªæ–°åˆ—ä¼šè‡ªåŠ¨æ·»åŠ åˆ°åˆå¹¶åçš„è¡¨æ ¼ä¸­</small>
                    </div>
                </div>
                
                <!-- ç¬¬äºŒæ­¥:å­ä¸²æå–(å¯é€‰) -->
                <div class="config-section">
                    <h4>2ï¸âƒ£ å­ä¸²æå–(å¯é€‰)</h4>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enable-extraction" onchange="toggleExtraction()"> å¯ç”¨å­ä¸²æå–
                        </label>
                        <span class="help-text">å¦‚æœåªéœ€è¦æºåˆ—å†…å®¹çš„ä¸€éƒ¨åˆ†,å‹¾é€‰æ­¤é¡¹</span>
                    </div>
                </div>
                
                <div id="extraction-form" style="display:none">
                    <div class="example-box">
                        <strong>ğŸ“ ç¤ºä¾‹:</strong> å­¦å· "202401001"
                        <ul>
                            <li>æå–ä½ç½® 1-4 â†’ "2024" (å¹´ä»½)</li>
                            <li>æå–ä½ç½® 5-6 â†’ "01" (ç­çº§ä»£ç )</li>
                            <li>æå–ä½ç½® 7-9 â†’ "001" (å­¦ç”Ÿç¼–å·)</li>
                        </ul>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="extraction-start">èµ·å§‹ä½ç½® <span class="help-text">ä»ç¬¬å‡ ä¸ªå­—ç¬¦å¼€å§‹?</span></label>
                            <input type="number" id="extraction-start" class="form-control" placeholder="ä¾‹å¦‚:5" min="1">
                            <small class="form-hint">ğŸ’¡ ç¬¬ä¸€ä¸ªå­—ç¬¦çš„ä½ç½®æ˜¯1</small>
                        </div>
                        <div class="form-group">
                            <label for="extraction-end">ç»“æŸä½ç½® <span class="help-text">åˆ°ç¬¬å‡ ä¸ªå­—ç¬¦ç»“æŸ?</span></label>
                            <input type="number" id="extraction-end" class="form-control" placeholder="ä¾‹å¦‚:6" min="1">
                            <small class="form-hint">ğŸ’¡ <strong>åŒ…å«</strong>è¿™ä¸ªä½ç½®çš„å­—ç¬¦ (ä½ç½®5-6ä¼šæå–2ä¸ªå­—ç¬¦)</small>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="extraction-one-indexed" checked> ä½¿ç”¨1ç´¢å¼•
                            </label>
                            <small class="form-hint">å‹¾é€‰:ç¬¬1ä¸ªå­—ç¬¦ä½ç½®æ˜¯1<br>ä¸å‹¾é€‰:ç¬¬1ä¸ªå­—ç¬¦ä½ç½®æ˜¯0</small>
                        </div>
                    </div>
                </div>

                <!-- ç¬¬ä¸‰æ­¥:æ˜ å°„è§„åˆ™(å¯é€‰) -->
                <div class="config-section">
                    <h4>3ï¸âƒ£ æ˜ å°„è§„åˆ™(å¯é€‰)</h4>
                    <p class="help-text">å°†æå–çš„å†…å®¹è½¬æ¢ä¸ºæ›´æ˜“è¯»çš„å€¼</p>
                    
                    <div class="example-box">
                        <strong>ğŸ“ ç¤ºä¾‹åœºæ™¯:</strong>
                        <table class="example-table">
                            <tr>
                                <th>æå–ç»“æœ</th>
                                <th>â†’</th>
                                <th>æ˜ å°„å</th>
                                <th>è¯´æ˜</th>
                            </tr>
                            <tr>
                                <td>"01"</td>
                                <td>â†’</td>
                                <td>"ä¸€ç­"</td>
                                <td>æ¨¡å¼: 01, å€¼: ä¸€ç­</td>
                            </tr>
                            <tr>
                                <td>"02"</td>
                                <td>â†’</td>
                                <td>"äºŒç­"</td>
                                <td>æ¨¡å¼: 02, å€¼: äºŒç­</td>
                            </tr>
                            <tr>
                                <td>"99"</td>
                                <td>â†’</td>
                                <td>"99"</td>
                                <td>æ²¡æœ‰åŒ¹é…è§„åˆ™,ä¿æŒåŸæ ·</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="mapping-instructions">
                        <p><strong>ğŸ“Œ å¦‚ä½•å¡«å†™æ˜ å°„è§„åˆ™?</strong></p>
                        <ol>
                            <li><strong>æ¨¡å¼:</strong> è¦åŒ¹é…çš„æ–‡æœ¬(å¦‚ "01", "02")</li>
                            <li><strong>å€¼:</strong> è½¬æ¢åçš„æ–‡æœ¬(å¦‚ "ä¸€ç­", "äºŒç­")</li>
                            <li><strong>åŒ¹é…æ–¹å¼:</strong> ä½¿ç”¨<strong>ç²¾ç¡®åŒ¹é…</strong>,æ¨¡å¼"01"åªåŒ¹é…"01",ä¸åŒ¹é…"001"æˆ–"0012"</li>
                            <li><strong>å¿«æ·é”®:</strong> å¡«å®Œä¸€è¡ŒæŒ‰ <kbd>Tab</kbd> æˆ– <kbd>Enter</kbd> è‡ªåŠ¨æ·»åŠ ä¸‹ä¸€è¡Œ</li>
                            <li><strong>æç¤º:</strong> å¦‚æœæ²¡æœ‰åŒ¹é…çš„è§„åˆ™,ä¼šä¿ç•™æå–çš„åŸå§‹å€¼</li>
                        </ol>
                        
                        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin-top: 10px;">
                            <strong>âš ï¸ é‡è¦æç¤º - ç²¾ç¡®åŒ¹é…:</strong>
                            <ul style="margin: 5px 0 0 20px;">
                                <li>âœ… æ¨¡å¼ "01" åŒ¹é… "01" â†’ æ­£ç¡®</li>
                                <li>âŒ æ¨¡å¼ "01" ä¸åŒ¹é… "001" â†’ ä¸ä¼šè½¬æ¢</li>
                                <li>âŒ æ¨¡å¼ "1" ä¸åŒ¹é… "01" æˆ– "10" â†’ ä¸ä¼šè½¬æ¢</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="keyboard-shortcuts-help" style="background: #e8f5e9; border-left: 4px solid #4caf50; padding: 12px; margin: 15px 0; border-radius: 4px;">
                        <strong>âŒ¨ï¸ é”®ç›˜å¿«æ·é”®(ç±»ä¼¼Excel):</strong>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 8px; font-size: 14px;">
                            <div><kbd>â†‘</kbd> <kbd>â†“</kbd> ä¸Šä¸‹ç§»åŠ¨</div>
                            <div><kbd>â†</kbd> <kbd>â†’</kbd> å·¦å³ç§»åŠ¨</div>
                            <div><kbd>Tab</kbd> ä¸‹ä¸€ä¸ªå­—æ®µ</div>
                            <div><kbd>Shift+Tab</kbd> ä¸Šä¸€ä¸ªå­—æ®µ</div>
                            <div><kbd>Enter</kbd> ä¸‹ä¸€è¡Œ/æ–°å¢</div>
                            <div><kbd>Ctrl+Enter</kbd> æ’å…¥è¡Œ</div>
                            <div><kbd>Ctrl+Del</kbd> åˆ é™¤è¡Œ</div>
                            <div><kbd>â†“</kbd> åœ¨æœ€åä¸€è¡Œè‡ªåŠ¨æ–°å¢</div>
                        </div>
                    </div>
                    
                    <p class="form-hint">
                        ğŸ’¡ æç¤º: ä½¿ç”¨é”®ç›˜å¿«æ·é”®å¯ä»¥å¤§å¹…æé«˜è¾“å…¥æ•ˆç‡,å°±åƒåœ¨Excelä¸­ä¸€æ ·!
                    </p>
                    <div id="mappings-container"></div>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addMapping()">+ æ·»åŠ æ˜ å°„è§„åˆ™</button>
                </div>
                
                <!-- å®Œæ•´ç¤ºä¾‹ -->
                <div class="complete-example">
                    <h4>ğŸ¯ å®Œæ•´ç¤ºä¾‹</h4>
                    <div class="example-card">
                        <div class="example-header">åœºæ™¯: ä»å­¦å·ç”Ÿæˆç­çº§åˆ—</div>
                        <div class="example-content">
                            <div class="example-step">
                                <strong>æºæ•°æ®:</strong>
                                <pre>å­¦å·
202401001
202401002
202402001
202402002</pre>
                            </div>
                            <div class="example-step">
                                <strong>é…ç½®:</strong>
                                <ul>
                                    <li>æºåˆ—å: <code>å­¦å·</code></li>
                                    <li>æ–°åˆ—å: <code>ç­çº§</code></li>
                                    <li>â˜‘ï¸ å¯ç”¨å­ä¸²æå–
                                        <ul>
                                            <li>èµ·å§‹ä½ç½®: <code>5</code></li>
                                            <li>ç»“æŸä½ç½®: <code>6</code></li>
                                        </ul>
                                    </li>
                                    <li>æ˜ å°„è§„åˆ™:
                                        <ul>
                                            <li>æ¨¡å¼: <code>01</code> â†’ å€¼: <code>ä¸€ç­</code></li>
                                            <li>æ¨¡å¼: <code>02</code> â†’ å€¼: <code>äºŒç­</code></li>
                                        </ul>
                                    </li>
                                </ul>
                            </div>
                            <div class="example-step">
                                <strong>ç»“æœ:</strong>
                                <pre>å­¦å·        ç­çº§
202401001   ä¸€ç­
202401002   ä¸€ç­
202402001   äºŒç­
202402002   äºŒç­</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="wizard-actions">
                <button type="button" class="btn btn-secondary" onclick="previousStep()">ä¸Šä¸€æ­¥</button>
                <button type="button" class="btn btn-primary" onclick="saveColumnRuleAndNext()">ä¸‹ä¸€æ­¥</button>
            </div>
        </div>

        <!-- æ­¥éª¤ 4: å•å…ƒæ ¼æ“ä½œ -->
        <div class="wizard-panel" data-panel="4">
            <h2>ç¬¬å››æ­¥:å•å…ƒæ ¼æ‰¹é‡æ“ä½œ(å¯é€‰)</h2>
            <p class="panel-hint">å¯¹æŒ‡å®šåˆ—çš„å•å…ƒæ ¼è¿›è¡Œç»Ÿä¸€ä¿®æ”¹</p>
            <p class="form-hint">
                ğŸ’¡ å¿«æ·é”®: <kbd>Tab</kbd> ä¸‹ä¸€ä¸ª | <kbd>Enter</kbd> æ–°å¢è¡Œ | <kbd>Ctrl+Del</kbd> åˆ é™¤è¡Œ
            </p>
            
            <div id="operations-container"></div>
            <button type="button" class="btn btn-sm btn-secondary" onclick="addOperation()">+ æ·»åŠ æ“ä½œ</button>

            <div class="wizard-actions">
                <button type="button" class="btn btn-secondary" onclick="previousStep()">ä¸Šä¸€æ­¥</button>
                <button type="button" class="btn btn-primary" onclick="saveCellOperationsAndNext()">ä¸‹ä¸€æ­¥</button>
            </div>
        </div>

        <!-- æ­¥éª¤ 5: æ‰§è¡Œå¤„ç† -->
        <div class="wizard-panel" data-panel="5">
            <h2>ç¬¬äº”æ­¥:æ‰§è¡Œå¤„ç†</h2>
            <div class="summary">
                <h3>ä»»åŠ¡é…ç½®æ±‡æ€»</h3>
                <div class="summary-item">
                    <span class="summary-label">ä»»åŠ¡åç§°:</span>
                    <span id="summary-name"></span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">è¾“å‡ºæ ¼å¼:</span>
                    <span id="summary-format"></span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">æ–‡ä»¶æ•°é‡:</span>
                    <span id="summary-files"></span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">åˆ—è¿‡æ»¤:</span>
                    <span id="summary-filter"></span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">åˆ—è§„åˆ™:</span>
                    <span id="summary-rule"></span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">æ“ä½œæ•°é‡:</span>
                    <span id="summary-ops"></span>
                </div>
            </div>

            <div id="process-status" class="process-status"></div>

            <div class="wizard-actions">
                <button type="button" class="btn btn-secondary" onclick="previousStep()">ä¸Šä¸€æ­¥</button>
                <button type="button" class="btn btn-success btn-lg" id="process-btn" onclick="processTask()">å¼€å§‹å¤„ç†</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentTaskId = null;
let currentStep = 1;
let uploadedFiles = [];
let mappings = [];
let operations = [];

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥URLå‚æ•°
window.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const taskId = urlParams.get('task_id');
    
    if (taskId) {
        loadExistingTask(taskId);
    }
});

// æ­¥éª¤å¯¼èˆª
function nextStep() {
    if (currentStep < 5) {
        currentStep++;
        updateWizard();
    }
}

function previousStep() {
    if (currentStep > 1) {
        currentStep--;
        updateWizard();
    }
}

function updateWizard() {
    document.querySelectorAll('.wizard-step').forEach(step => {
        const stepNum = parseInt(step.dataset.step);
        step.classList.toggle('active', stepNum === currentStep);
        step.classList.toggle('completed', stepNum < currentStep);
    });
    
    document.querySelectorAll('.wizard-panel').forEach(panel => {
        panel.classList.toggle('active', parseInt(panel.dataset.panel) === currentStep);
    });

    if (currentStep === 5) {
        updateSummary();
    }
}

// åˆ‡æ¢åˆ—è¿‡æ»¤è¡¨å•æ˜¾ç¤º
function toggleFilterColumns() {
    const filterMode = document.getElementById('filter-mode').value;
    const filterColumnsForm = document.getElementById('filter-columns-form');
    filterColumnsForm.style.display = (filterMode === 'none') ? 'none' : 'block';
}

// åˆ‡æ¢åˆ—æ´¾ç”Ÿè§„åˆ™è¡¨å•æ˜¾ç¤º
function toggleColumnRule() {
    const form = document.getElementById('column-rule-form');
    const button = event.target;
    if (form.style.display === 'none') {
        form.style.display = 'block';
        button.textContent = 'éšè—é…ç½®è¡¨å•';
    } else {
        form.style.display = 'none';
        button.textContent = 'æ˜¾ç¤ºé…ç½®è¡¨å•';
    }
}

// åˆ‡æ¢æå–è§„åˆ™è¡¨å•æ˜¾ç¤º
function toggleExtraction() {
    const form = document.getElementById('extraction-form');
    const button = event.target;
    if (form.style.display === 'none') {
        form.style.display = 'block';
        button.textContent = 'éšè—æå–è§„åˆ™';
    } else {
        form.style.display = 'none';
        button.textContent = 'æ˜¾ç¤ºæå–è§„åˆ™';
    }
}

// åˆ›å»ºä»»åŠ¡
function createTask() {
    // å¦‚æœå·²æœ‰ä»»åŠ¡ID,ç›´æ¥è·³åˆ°ä¸‹ä¸€æ­¥
    if (currentTaskId) {
        nextStep();
        return;
    }
    
    const name = document.getElementById('task-name').value.trim();
    if (!name) {
        alert('è¯·è¾“å…¥ä»»åŠ¡åç§°');
        return;
    }

    const outputFormat = document.getElementById('output-format').value;
    const filterMode = document.getElementById('filter-mode').value;
    
    // è·å–åˆ—è¿‡æ»¤åˆ—è¡¨
    let filterColumns = [];
    if (filterMode !== 'none') {
        const columnsText = document.getElementById('filter-columns').value.trim();
        if (columnsText) {
            filterColumns = columnsText.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
        }
    }

    fetch('/api/tasks/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ 
            name, 
            output_format: outputFormat,
            filter_mode: filterMode,
            filter_columns: filterColumns
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentTaskId = data.task_id;
            nextStep();
        } else {
            alert('åˆ›å»ºä»»åŠ¡å¤±è´¥: ' + data.error);
        }
    })
    .catch(error => {
        alert('åˆ›å»ºä»»åŠ¡å¤±è´¥: ' + error);
    });
}

// æ–‡ä»¶ä¸Šä¼ äº‹ä»¶ç»‘å®š
document.addEventListener('DOMContentLoaded', function() {
    
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');

    uploadArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFiles);

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        handleFiles({ target: { files: e.dataTransfer.files } });
    });

    // åˆ—è§„åˆ™å¼€å…³
    document.getElementById('enable-column-rule').addEventListener('change', function() {
        document.getElementById('column-rule-form').style.display = this.checked ? 'block' : 'none';
    });

    document.getElementById('enable-extraction').addEventListener('change', function() {
        document.getElementById('extraction-form').style.display = this.checked ? 'block' : 'none';
    });
});

function handleFiles(e) {
    const files = Array.from(e.target.files);
    const formData = new FormData();
    formData.append('task_id', currentTaskId);
    
    files.forEach(file => {
        formData.append('files', file);
    });

    fetch(`/api/tasks/${currentTaskId}/upload/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            uploadedFiles = uploadedFiles.concat(data.files);
            updateFileList();
        } else {
            alert('ä¸Šä¼ å¤±è´¥: ' + data.error);
        }
    });
}

function updateFileList() {
    const fileList = document.getElementById('file-list');
    fileList.innerHTML = uploadedFiles.map(file => `
        <div class="file-item">
            <span class="file-icon">ğŸ“„</span>
            <span class="file-name">${file.name}</span>
            <button type="button" class="btn btn-sm btn-danger" onclick="deleteFile(${file.id})">åˆ é™¤</button>
        </div>
    `).join('');
}

function deleteFile(fileId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—?')) return;
    
    fetch(`/api/files/${fileId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            uploadedFiles = uploadedFiles.filter(f => f.id !== fileId);
            updateFileList();
        } else {
            alert('åˆ é™¤å¤±è´¥: ' + data.error);
        }
    });
}

// åˆ—è§„åˆ™
function addMapping() {
    const container = document.getElementById('mappings-container');
    const index = mappings.length;
    const div = document.createElement('div');
    div.className = 'mapping-item';
    div.innerHTML = `
        <input type="text" placeholder="æ¨¡å¼" class="form-control mapping-pattern" data-index="${index}" onkeydown="handleMappingKeydown(event, ${index}, 'pattern')">
        <input type="text" placeholder="å€¼" class="form-control mapping-value" data-index="${index}" onkeydown="handleMappingKeydown(event, ${index}, 'value')">
        <button type="button" class="btn btn-sm btn-danger" onclick="removeMapping(${index})">åˆ é™¤</button>
    `;
    container.appendChild(div);
    mappings.push({ pattern: '', value: '' });
    
    // è‡ªåŠ¨èšç„¦åˆ°æ–°æ·»åŠ çš„æ¨¡å¼è¾“å…¥æ¡†
    setTimeout(() => {
        const newInput = div.querySelector('.mapping-pattern');
        if (newInput) newInput.focus();
    }, 0);
}

function removeMapping(index) {
    const items = document.querySelectorAll('.mapping-item');
    if (items.length > 0 && items[index]) {
        items[index].remove();
        mappings.splice(index, 1);
        // æ›´æ–°å‰©ä½™é¡¹çš„ç´¢å¼•
        updateMappingIndices();
    }
}

// åœ¨æŒ‡å®šç´¢å¼•åæ’å…¥æ–°çš„æ˜ å°„è¡Œ
function insertMappingAfter(index) {
    const container = document.getElementById('mappings-container');
    const items = Array.from(document.querySelectorAll('.mapping-item'));
    const newIndex = index + 1;
    
    const div = document.createElement('div');
    div.className = 'mapping-item';
    div.innerHTML = `
        <input type="text" placeholder="æ¨¡å¼" class="form-control mapping-pattern" data-index="${newIndex}" onkeydown="handleMappingKeydown(event, ${newIndex}, 'pattern')">
        <input type="text" placeholder="å€¼" class="form-control mapping-value" data-index="${newIndex}" onkeydown="handleMappingKeydown(event, ${newIndex}, 'value')">
        <button type="button" class="btn btn-sm btn-danger" onclick="removeMapping(${newIndex})">åˆ é™¤</button>
    `;
    
    // åœ¨æŒ‡å®šä½ç½®æ’å…¥
    if (index < items.length - 1) {
        items[index].after(div);
    } else {
        container.appendChild(div);
    }
    
    mappings.splice(newIndex, 0, { pattern: '', value: '' });
    updateMappingIndices();
    
    // èšç„¦åˆ°æ–°è¡Œçš„æ¨¡å¼è¾“å…¥æ¡†
    setTimeout(() => {
        const newInput = div.querySelector('.mapping-pattern');
        if (newInput) newInput.focus();
    }, 0);
}

// æ›´æ–°æ‰€æœ‰æ˜ å°„é¡¹çš„ç´¢å¼•
function updateMappingIndices() {
    const items = document.querySelectorAll('.mapping-item');
    items.forEach((item, idx) => {
        const patternInput = item.querySelector('.mapping-pattern');
        const valueInput = item.querySelector('.mapping-value');
        const deleteBtn = item.querySelector('button');
        
        if (patternInput) {
            patternInput.setAttribute('data-index', idx);
            patternInput.setAttribute('onkeydown', `handleMappingKeydown(event, ${idx}, 'pattern')`);
        }
        if (valueInput) {
            valueInput.setAttribute('data-index', idx);
            valueInput.setAttribute('onkeydown', `handleMappingKeydown(event, ${idx}, 'value')`);
        }
        if (deleteBtn) {
            deleteBtn.setAttribute('onclick', `removeMapping(${idx})`);
        }
    });
}

// å¤„ç†é”®ç›˜äº‹ä»¶,å®ç°ç±»ä¼¼Excelçš„å¯¼èˆªå’Œè‡ªåŠ¨å¡«å……
function handleMappingKeydown(event, index, field) {
    const items = document.querySelectorAll('.mapping-item');
    const currentItem = items[index];
    if (!currentItem) return;
    
    // Tabé”®:ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªè¾“å…¥æ¡†,å¦‚æœæ˜¯æœ€åä¸€ä¸ªå€¼è¾“å…¥æ¡†åˆ™è‡ªåŠ¨æ·»åŠ æ–°è¡Œ
    if (event.key === 'Tab' && !event.shiftKey) {
        if (field === 'value') {
            event.preventDefault();
            // å¦‚æœæ˜¯æœ€åä¸€è¡Œ,æ·»åŠ æ–°è¡Œ
            if (index === items.length - 1) {
                addMapping();
            } else {
                // å¦åˆ™ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œçš„æ¨¡å¼è¾“å…¥æ¡†
                const nextItem = items[index + 1];
                const nextInput = nextItem?.querySelector('.mapping-pattern');
                if (nextInput) nextInput.focus();
            }
        }
        // å¦‚æœæ˜¯æ¨¡å¼è¾“å…¥æ¡†,é»˜è®¤è¡Œä¸ºä¼šç§»åŠ¨åˆ°å€¼è¾“å…¥æ¡†
    }
    
    // Shift+Tabé”®:ç§»åŠ¨åˆ°ä¸Šä¸€ä¸ªè¾“å…¥æ¡†
    if (event.key === 'Tab' && event.shiftKey) {
        if (field === 'pattern' && index > 0) {
            event.preventDefault();
            const prevItem = items[index - 1];
            const prevInput = prevItem?.querySelector('.mapping-value');
            if (prevInput) prevInput.focus();
        }
    }
    
    // Enteré”®:ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œæˆ–æ·»åŠ æ–°è¡Œ
    if (event.key === 'Enter') {
        event.preventDefault();
        if (field === 'pattern') {
            // åœ¨æ¨¡å¼è¾“å…¥æ¡†æŒ‰Enter,ç§»åŠ¨åˆ°å€¼è¾“å…¥æ¡†
            const valueInput = currentItem.querySelector('.mapping-value');
            if (valueInput) valueInput.focus();
        } else {
            // åœ¨å€¼è¾“å…¥æ¡†æŒ‰Enter,ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œæˆ–æ·»åŠ æ–°è¡Œ
            if (index === items.length - 1) {
                addMapping();
            } else {
                const nextItem = items[index + 1];
                const nextInput = nextItem?.querySelector('.mapping-pattern');
                if (nextInput) nextInput.focus();
            }
        }
    }
    
    // æ–¹å‘é”®ä¸Š:ç§»åŠ¨åˆ°ä¸Šä¸€è¡Œ
    if (event.key === 'ArrowUp') {
        event.preventDefault();
        if (index > 0) {
            const prevItem = items[index - 1];
            const prevInput = prevItem?.querySelector(`.mapping-${field}`);
            if (prevInput) prevInput.focus();
        }
    }
    
    // æ–¹å‘é”®ä¸‹:ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œ
    if (event.key === 'ArrowDown') {
        event.preventDefault();
        if (index < items.length - 1) {
            const nextItem = items[index + 1];
            const nextInput = nextItem?.querySelector(`.mapping-${field}`);
            if (nextInput) nextInput.focus();
        } else {
            // å¦‚æœæ˜¯æœ€åä¸€è¡Œ,æ·»åŠ æ–°è¡Œ
            addMapping();
        }
    }
    
    // æ–¹å‘é”®å·¦:ç§»åŠ¨åˆ°æ¨¡å¼è¾“å…¥æ¡†(ä»…å½“å…‰æ ‡åœ¨å¼€å¤´æ—¶)
    if (event.key === 'ArrowLeft' && field === 'value' && event.target.selectionStart === 0) {
        event.preventDefault();
        const patternInput = currentItem.querySelector('.mapping-pattern');
        if (patternInput) {
            patternInput.focus();
            patternInput.selectionStart = patternInput.value.length;
            patternInput.selectionEnd = patternInput.value.length;
        }
    }
    
    // æ–¹å‘é”®å³:ç§»åŠ¨åˆ°å€¼è¾“å…¥æ¡†(ä»…å½“å…‰æ ‡åœ¨æœ«å°¾æ—¶)
    if (event.key === 'ArrowRight' && field === 'pattern' && 
        event.target.selectionStart === event.target.value.length) {
        event.preventDefault();
        const valueInput = currentItem.querySelector('.mapping-value');
        if (valueInput) {
            valueInput.focus();
            valueInput.selectionStart = 0;
            valueInput.selectionEnd = 0;
        }
    }
    
    // Ctrl+Delete:åˆ é™¤å½“å‰è¡Œ(ä½†è‡³å°‘ä¿ç•™ä¸€è¡Œ)
    if (event.key === 'Delete' && event.ctrlKey && items.length > 1) {
        event.preventDefault();
        removeMapping(index);
        // èšç„¦åˆ°ä¸Šä¸€è¡Œæˆ–ä¸‹ä¸€è¡Œ
        const nextIndex = index > 0 ? index - 1 : 0;
        setTimeout(() => {
            const nextItem = document.querySelectorAll('.mapping-item')[nextIndex];
            if (nextItem) {
                const focusInput = nextItem.querySelector(`.mapping-${field}`);
                if (focusInput) focusInput.focus();
            }
        }, 0);
    }
    
    // Ctrl+Enter:å¿«é€Ÿåœ¨å½“å‰è¡Œä¸‹æ–¹æ’å…¥æ–°è¡Œ
    if (event.key === 'Enter' && event.ctrlKey) {
        event.preventDefault();
        insertMappingAfter(index);
    }
}

function saveColumnRuleAndNext() {
    if (!document.getElementById('enable-column-rule').checked) {
        nextStep();
        return;
    }

    const sourceColumn = document.getElementById('source-column').value;
    const newColumn = document.getElementById('new-column').value;

    if (!sourceColumn || !newColumn) {
        alert('è¯·å¡«å†™æºåˆ—åå’Œæ–°åˆ—å');
        return;
    }

    // æ”¶é›†æ˜ å°„
    const mappingElements = document.querySelectorAll('.mapping-pattern');
    const mappings = Array.from(mappingElements).map((el, i) => ({
        pattern: el.value,
        value: document.querySelectorAll('.mapping-value')[i].value
    })).filter(m => m.pattern && m.value);

    const ruleData = {
        name: 'åˆ—è§„åˆ™',
        source_column: sourceColumn,
        new_column: newColumn,
        mappings: mappings
    };

    if (document.getElementById('enable-extraction').checked) {
        ruleData.extraction_start = parseInt(document.getElementById('extraction-start').value);
        ruleData.extraction_end = parseInt(document.getElementById('extraction-end').value);
        ruleData.extraction_one_indexed = document.getElementById('extraction-one-indexed').checked;
    }

    fetch(`/api/tasks/${currentTaskId}/column-rule/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(ruleData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            nextStep();
        } else {
            alert('ä¿å­˜åˆ—è§„åˆ™å¤±è´¥: ' + data.error);
        }
    });
}

// å•å…ƒæ ¼æ“ä½œ
function addOperation() {
    const container = document.getElementById('operations-container');
    const index = operations.length;
    const div = document.createElement('div');
    div.className = 'operation-item';
    div.innerHTML = `
        <div class="form-row">
            <input type="text" placeholder="åˆ—å" class="form-control op-column" data-index="${index}" onkeydown="handleOperationKeydown(event, ${index}, 'column')">
            <select class="form-control op-action" data-index="${index}" onkeydown="handleOperationKeydown(event, ${index}, 'action')">
                <option value="add_prefix">æ·»åŠ å‰ç¼€</option>
                <option value="add_suffix">æ·»åŠ åç¼€</option>
                <option value="remove_prefix">åˆ é™¤å‰ç¼€</option>
                <option value="remove_suffix">åˆ é™¤åç¼€</option>
                <option value="replace">æ›¿æ¢æ–‡æœ¬</option>
            </select>
            <input type="text" placeholder="å€¼" class="form-control op-value" data-index="${index}" onkeydown="handleOperationKeydown(event, ${index}, 'value')">
            <button type="button" class="btn btn-sm btn-danger" onclick="removeOperation(${index})">åˆ é™¤</button>
        </div>
    `;
    container.appendChild(div);
    operations.push({});
    
    // è‡ªåŠ¨èšç„¦åˆ°æ–°æ·»åŠ çš„åˆ—åè¾“å…¥æ¡†
    setTimeout(() => {
        const newInput = div.querySelector('.op-column');
        if (newInput) newInput.focus();
    }, 0);
}

function removeOperation(index) {
    const items = document.querySelectorAll('.operation-item');
    if (items.length > 0 && items[index]) {
        items[index].remove();
        operations.splice(index, 1);
        // æ›´æ–°å‰©ä½™é¡¹çš„ç´¢å¼•
        updateOperationIndices();
    }
}

// åœ¨æŒ‡å®šç´¢å¼•åæ’å…¥æ–°çš„æ“ä½œè¡Œ
function insertOperationAfter(index) {
    const container = document.getElementById('operations-container');
    const items = Array.from(document.querySelectorAll('.operation-item'));
    const newIndex = index + 1;
    
    const div = document.createElement('div');
    div.className = 'operation-item';
    div.innerHTML = `
        <div class="form-row">
            <input type="text" placeholder="åˆ—å" class="form-control op-column" data-index="${newIndex}" onkeydown="handleOperationKeydown(event, ${newIndex}, 'column')">
            <select class="form-control op-action" data-index="${newIndex}" onkeydown="handleOperationKeydown(event, ${newIndex}, 'action')">
                <option value="add_prefix">æ·»åŠ å‰ç¼€</option>
                <option value="add_suffix">æ·»åŠ åç¼€</option>
                <option value="remove_prefix">åˆ é™¤å‰ç¼€</option>
                <option value="remove_suffix">åˆ é™¤åç¼€</option>
                <option value="replace">æ›¿æ¢æ–‡æœ¬</option>
            </select>
            <input type="text" placeholder="å€¼" class="form-control op-value" data-index="${newIndex}" onkeydown="handleOperationKeydown(event, ${newIndex}, 'value')">
            <button type="button" class="btn btn-sm btn-danger" onclick="removeOperation(${newIndex})">åˆ é™¤</button>
        </div>
    `;
    
    // åœ¨æŒ‡å®šä½ç½®æ’å…¥
    if (index < items.length - 1) {
        items[index].after(div);
    } else {
        container.appendChild(div);
    }
    
    operations.splice(newIndex, 0, {});
    updateOperationIndices();
    
    // èšç„¦åˆ°æ–°è¡Œçš„åˆ—åè¾“å…¥æ¡†
    setTimeout(() => {
        const newInput = div.querySelector('.op-column');
        if (newInput) newInput.focus();
    }, 0);
}

// æ›´æ–°æ‰€æœ‰æ“ä½œé¡¹çš„ç´¢å¼•
function updateOperationIndices() {
    const items = document.querySelectorAll('.operation-item');
    items.forEach((item, idx) => {
        const columnInput = item.querySelector('.op-column');
        const actionSelect = item.querySelector('.op-action');
        const valueInput = item.querySelector('.op-value');
        const deleteBtn = item.querySelector('button');
        
        if (columnInput) {
            columnInput.setAttribute('data-index', idx);
            columnInput.setAttribute('onkeydown', `handleOperationKeydown(event, ${idx}, 'column')`);
        }
        if (actionSelect) {
            actionSelect.setAttribute('data-index', idx);
            actionSelect.setAttribute('onkeydown', `handleOperationKeydown(event, ${idx}, 'action')`);
        }
        if (valueInput) {
            valueInput.setAttribute('data-index', idx);
            valueInput.setAttribute('onkeydown', `handleOperationKeydown(event, ${idx}, 'value')`);
        }
        if (deleteBtn) {
            deleteBtn.setAttribute('onclick', `removeOperation(${idx})`);
        }
    });
}

// å¤„ç†å•å…ƒæ ¼æ“ä½œçš„é”®ç›˜äº‹ä»¶ - ç±»ä¼¼Excelçš„å¯¼èˆª
function handleOperationKeydown(event, index, field) {
    const items = document.querySelectorAll('.operation-item');
    const currentItem = items[index];
    if (!currentItem) return;
    
    // Tabé”®:ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªè¾“å…¥æ¡†
    if (event.key === 'Tab' && !event.shiftKey) {
        if (field === 'value') {
            event.preventDefault();
            // å¦‚æœæ˜¯æœ€åä¸€è¡Œ,æ·»åŠ æ–°è¡Œ
            if (index === items.length - 1) {
                addOperation();
            } else {
                // å¦åˆ™ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œçš„åˆ—åè¾“å…¥æ¡†
                const nextItem = items[index + 1];
                const nextInput = nextItem?.querySelector('.op-column');
                if (nextInput) nextInput.focus();
            }
        }
    }
    
    // Shift+Tabé”®:ç§»åŠ¨åˆ°ä¸Šä¸€ä¸ªè¾“å…¥æ¡†
    if (event.key === 'Tab' && event.shiftKey) {
        if (field === 'column' && index > 0) {
            event.preventDefault();
            const prevItem = items[index - 1];
            const prevInput = prevItem?.querySelector('.op-value');
            if (prevInput) prevInput.focus();
        }
    }
    
    // Enteré”®:ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå­—æ®µæˆ–ä¸‹ä¸€è¡Œ
    if (event.key === 'Enter') {
        event.preventDefault();
        if (field === 'column') {
            const actionSelect = currentItem.querySelector('.op-action');
            if (actionSelect) actionSelect.focus();
        } else if (field === 'action') {
            const valueInput = currentItem.querySelector('.op-value');
            if (valueInput) valueInput.focus();
        } else if (field === 'value') {
            // åœ¨å€¼è¾“å…¥æ¡†æŒ‰Enter,ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œæˆ–æ·»åŠ æ–°è¡Œ
            if (index === items.length - 1) {
                addOperation();
            } else {
                const nextItem = items[index + 1];
                const nextInput = nextItem?.querySelector('.op-column');
                if (nextInput) nextInput.focus();
            }
        }
    }
    
    // æ–¹å‘é”®ä¸Š:ç§»åŠ¨åˆ°ä¸Šä¸€è¡Œ
    if (event.key === 'ArrowUp') {
        event.preventDefault();
        if (index > 0) {
            const prevItem = items[index - 1];
            const prevInput = prevItem?.querySelector(`.op-${field}`);
            if (prevInput) prevInput.focus();
        }
    }
    
    // æ–¹å‘é”®ä¸‹:ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œ
    if (event.key === 'ArrowDown') {
        event.preventDefault();
        if (index < items.length - 1) {
            const nextItem = items[index + 1];
            const nextInput = nextItem?.querySelector(`.op-${field}`);
            if (nextInput) nextInput.focus();
        } else {
            // å¦‚æœæ˜¯æœ€åä¸€è¡Œ,æ·»åŠ æ–°è¡Œ
            addOperation();
        }
    }
    
    // æ–¹å‘é”®å·¦:ç§»åŠ¨åˆ°ä¸Šä¸€ä¸ªå­—æ®µ(ä»…å½“å…‰æ ‡åœ¨å¼€å¤´æ—¶)
    if (event.key === 'ArrowLeft' && event.target.selectionStart === 0) {
        event.preventDefault();
        if (field === 'action') {
            const columnInput = currentItem.querySelector('.op-column');
            if (columnInput) {
                columnInput.focus();
                columnInput.selectionStart = columnInput.value.length;
                columnInput.selectionEnd = columnInput.value.length;
            }
        } else if (field === 'value') {
            const actionSelect = currentItem.querySelector('.op-action');
            if (actionSelect) actionSelect.focus();
        }
    }
    
    // æ–¹å‘é”®å³:ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå­—æ®µ(ä»…å½“å…‰æ ‡åœ¨æœ«å°¾æ—¶)
    if (event.key === 'ArrowRight') {
        const atEnd = field === 'action' || 
                     (event.target.selectionStart === event.target.value.length);
        if (atEnd) {
            event.preventDefault();
            if (field === 'column') {
                const actionSelect = currentItem.querySelector('.op-action');
                if (actionSelect) actionSelect.focus();
            } else if (field === 'action') {
                const valueInput = currentItem.querySelector('.op-value');
                if (valueInput) {
                    valueInput.focus();
                    valueInput.selectionStart = 0;
                    valueInput.selectionEnd = 0;
                }
            }
        }
    }
    
    // Ctrl+Delete:åˆ é™¤å½“å‰è¡Œ(ä½†è‡³å°‘ä¿ç•™ä¸€è¡Œ)
    if (event.key === 'Delete' && event.ctrlKey && items.length > 1) {
        event.preventDefault();
        removeOperation(index);
        // èšç„¦åˆ°ä¸Šä¸€è¡Œæˆ–ä¸‹ä¸€è¡Œ
        const nextIndex = index > 0 ? index - 1 : 0;
        setTimeout(() => {
            const nextItem = document.querySelectorAll('.operation-item')[nextIndex];
            if (nextItem) {
                const focusInput = nextItem.querySelector(`.op-${field}`);
                if (focusInput) focusInput.focus();
            }
        }, 0);
    }
    
    // Ctrl+Enter:å¿«é€Ÿåœ¨å½“å‰è¡Œä¸‹æ–¹æ’å…¥æ–°è¡Œ
    if (event.key === 'Enter' && event.ctrlKey) {
        event.preventDefault();
        insertOperationAfter(index);
    }
}

function saveCellOperationsAndNext() {
    const opElements = document.querySelectorAll('.operation-item');
    const operations = Array.from(opElements).map((el, i) => {
        const column = el.querySelector('.op-column').value;
        const action = el.querySelector('.op-action').value;
        const value = el.querySelector('.op-value').value;
        return { column, action, value };
    }).filter(op => op.column);

    if (operations.length === 0) {
        nextStep();
        return;
    }

    fetch(`/api/tasks/${currentTaskId}/cell-operations/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            operations: operations
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            nextStep();
        } else {
            alert('ä¿å­˜æ“ä½œå¤±è´¥: ' + data.error);
        }
    });
}

// æ±‡æ€»
function updateSummary() {
    document.getElementById('summary-name').textContent = document.getElementById('task-name').value;
    document.getElementById('summary-format').textContent = document.getElementById('output-format').value.toUpperCase();
    document.getElementById('summary-files').textContent = uploadedFiles.length + ' ä¸ªæ–‡ä»¶';
    
    // åˆ—è¿‡æ»¤ä¿¡æ¯
    const filterMode = document.getElementById('filter-mode').value;
    const filterModeText = {
        'none': 'ä¸è¿‡æ»¤',
        'keep': 'åªä¿ç•™æŒ‡å®šåˆ—',
        'remove': 'åˆ é™¤æŒ‡å®šåˆ—'
    };
    let filterText = filterModeText[filterMode] || 'ä¸è¿‡æ»¤';
    if (filterMode !== 'none') {
        const columnsText = document.getElementById('filter-columns').value.trim();
        const columnCount = columnsText ? columnsText.split('\n').filter(l => l.trim()).length : 0;
        filterText += ` (${columnCount}åˆ—)`;
    }
    document.getElementById('summary-filter').textContent = filterText;
    
    document.getElementById('summary-rule').textContent = document.getElementById('enable-column-rule').checked ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨';
    document.getElementById('summary-ops').textContent = document.querySelectorAll('.operation-item').length + ' ä¸ªæ“ä½œ';
}

// å¤„ç†ä»»åŠ¡
function processTask() {
    const btn = document.getElementById('process-btn');
    btn.disabled = true;
    btn.textContent = 'å¤„ç†ä¸­...';

    const statusDiv = document.getElementById('process-status');
    statusDiv.innerHTML = '<div class="processing">æ­£åœ¨å¤„ç†,è¯·ç¨å€™...</div>';

    fetch(`/api/tasks/${currentTaskId}/process/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = `
                <div class="success">
                    <h3>âœ… å¤„ç†å®Œæˆ!</h3>
                    <p><a href="${data.download_url}" class="btn btn-success">ä¸‹è½½ç»“æœæ–‡ä»¶</a></p>
                    <p><a href="/tasks/${currentTaskId}/" class="btn btn-secondary">æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…</a></p>
                </div>
            `;
        } else {
            statusDiv.innerHTML = `<div class="error">å¤„ç†å¤±è´¥: ${data.error}</div>`;
            btn.disabled = false;
            btn.textContent = 'é‡æ–°å¤„ç†';
        }
    })
    .catch(error => {
        statusDiv.innerHTML = `<div class="error">å¤„ç†å¤±è´¥: ${error}</div>`;
        btn.disabled = false;
        btn.textContent = 'é‡æ–°å¤„ç†';
    });
}

// è·å– CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// åŠ è½½å·²æœ‰ä»»åŠ¡
function loadExistingTask(taskId) {
    fetch(`/api/tasks/${taskId}/status/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const task = data.task;
                
                // è®¾ç½®ä»»åŠ¡ID
                currentTaskId = task.id;
                
                // å¡«å……ä»»åŠ¡ä¿¡æ¯
                document.getElementById('task-name').value = task.name;
                document.getElementById('output-format').value = task.output_format;
                
                // å¡«å……åˆ—è¿‡æ»¤é…ç½®
                if (task.filter_mode) {
                    document.getElementById('filter-mode').value = task.filter_mode;
                    toggleFilterColumns();
                    if (task.filter_columns && task.filter_columns.length > 0) {
                        document.getElementById('filter-columns').value = task.filter_columns.join('\n');
                    }
                }
                
                // å¡«å……æ–‡ä»¶åˆ—è¡¨
                uploadedFiles = task.files;
                updateFileList();
                
                // å¡«å……åˆ—è§„åˆ™
                if (task.column_rule) {
                    const rule = task.column_rule;
                    document.getElementById('enable-column-rule').checked = true;
                    document.getElementById('column-rule-form').style.display = 'block';
                    document.getElementById('source-column').value = rule.source_column;
                    document.getElementById('new-column').value = rule.new_column;
                    
                    if (rule.extraction_start !== null) {
                        document.getElementById('enable-extraction').checked = true;
                        document.getElementById('extraction-form').style.display = 'block';
                        document.getElementById('extraction-start').value = rule.extraction_start;
                        document.getElementById('extraction-end').value = rule.extraction_end;
                        document.getElementById('extraction-one-indexed').checked = rule.extraction_one_indexed;
                    }
                    
                    // å¡«å……æ˜ å°„è§„åˆ™
                    rule.mappings.forEach(mapping => {
                        addMapping();
                        const index = mappings.length - 1;
                        document.querySelectorAll('.mapping-pattern')[index].value = mapping.pattern;
                        document.querySelectorAll('.mapping-value')[index].value = mapping.value;
                    });
                }
                
                // å¡«å……å•å…ƒæ ¼æ“ä½œ
                task.operations.forEach(op => {
                    addOperation();
                    const index = operations.length - 1;
                    const opItem = document.querySelectorAll('.operation-item')[index];
                    opItem.querySelector('.op-column').value = op.column;
                    opItem.querySelector('.op-action').value = op.action;
                    opItem.querySelector('.op-value').value = op.value || '';
                });
                
                alert('å·²åŠ è½½ä»»åŠ¡æ•°æ®,å¯ä»¥ç»§ç»­ä¿®æ”¹é…ç½®å¹¶å¤„ç†');
            } else {
                alert('åŠ è½½ä»»åŠ¡å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            alert('åŠ è½½ä»»åŠ¡å¤±è´¥: ' + error);
        });
}

</script>
{% endblock %}
