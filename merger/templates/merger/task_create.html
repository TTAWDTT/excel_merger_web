{% extends 'base.html' %}

{% block title %}åˆ›å»ºä»»åŠ¡ - Excel åˆå¹¶å·¥å…·{% endblock %}

{% block content %}
<div class="page-header">
    <h1>åˆ›å»ºåˆå¹¶ä»»åŠ¡</h1>
    <p>æŒ‰ç…§æ­¥éª¤é…ç½®æ‚¨çš„Excelåˆå¹¶ä»»åŠ¡</p>
</div>

<div class="wizard">
    <div class="wizard-steps">
        <div class="wizard-step active" data-step="1">
            <div class="step-indicator">1</div>
            <span>åŸºæœ¬é…ç½®</span>
        </div>
        <div class="wizard-step" data-step="2">
            <div class="step-indicator">2</div>
            <span>ä¸Šä¼ æ–‡ä»¶</span>
        </div>
        <div class="wizard-step" data-step="3">
            <div class="step-indicator">3</div>
            <span>æ•°æ®é¢„è§ˆæ¸…æ´—</span>
        </div>
        <div class="wizard-step" data-step="4">
            <div class="step-indicator">4</div>
            <span>é«˜çº§è®¾ç½®</span>
        </div>
        <div class="wizard-step" data-step="5">
            <div class="step-indicator">5</div>
            <span>ç¡®è®¤æ‰§è¡Œ</span>
        </div>
    </div>

    <div class="wizard-content">
        <!-- æ­¥éª¤ 1: åŸºæœ¬é…ç½® -->
        <div class="wizard-panel active" data-panel="1">
            <h2><i class="fas fa-cog"></i> åŸºæœ¬é…ç½®</h2>
            <p class="panel-hint">è®¾ç½®ä»»åŠ¡åç§°å’Œè¾“å‡ºæ ¼å¼</p>
            
            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label for="task-name"><i class="fas fa-tag"></i> ä»»åŠ¡åç§° *</label>
                    <input type="text" id="task-name" class="form-control" placeholder="ä¾‹å¦‚:2024å­¦ç”Ÿä¿¡æ¯åˆå¹¶" required>
                </div>
                <div class="form-group">
                    <label for="output-format"><i class="fas fa-file-export"></i> è¾“å‡ºæ ¼å¼ *</label>
                    <select id="output-format" class="form-control">
                        <option value="xlsx">XLSX (Excel 2007+,æ¨è)</option>
                        <option value="xls">XLS (Excel 2003å…¼å®¹)</option>
                        <option value="csv">CSV (é€šç”¨æ–‡æœ¬æ ¼å¼)</option>
                        <option value="json">JSON (ç¨‹åºæ¥å£æ ¼å¼)</option>
                    </select>
                </div>
            </div>
            
            <div class="config-section">
                <h4><i class="fas fa-filter"></i> åˆ—è¿‡æ»¤è®¾ç½® (å¯é€‰)</h4>
                <div class="form-group">
                    <label for="filter-mode">è¿‡æ»¤æ¨¡å¼</label>
                    <select id="filter-mode" class="form-control" onchange="toggleFilterColumns()">
                        <option value="none">ä¸è¿‡æ»¤åˆ— (ä¿ç•™æ‰€æœ‰åˆ—)</option>
                        <option value="keep">åªä¿ç•™æŒ‡å®šåˆ—</option>
                        <option value="remove">åˆ é™¤æŒ‡å®šåˆ—</option>
                    </select>
                </div>
                
                <div id="filter-columns-form" style="display:none">
                    <div class="form-group">
                        <label for="filter-columns">åˆ—ååˆ—è¡¨ (æ¯è¡Œä¸€ä¸ª)</label>
                        <textarea id="filter-columns" class="form-control" rows="4" placeholder="å§“å&#10;å­¦å·&#10;æˆç»©"></textarea>
                        <small class="form-hint"><i class="fas fa-info-circle"></i> è¾“å…¥åˆ—å,æ¯è¡Œä¸€ä¸ª</small>
                    </div>
                </div>
            </div>
            
            <div class="wizard-actions">
                <button type="button" class="btn btn-primary btn-lg" onclick="createTask()">
                    <i class="fas fa-arrow-right"></i> ä¸‹ä¸€æ­¥
                </button>
            </div>
        </div>

        <!-- æ­¥éª¤ 2: ä¸Šä¼ æ–‡ä»¶ -->
        <div class="wizard-panel" data-panel="2">
            <h2><i class="fas fa-cloud-upload-alt"></i> ä¸Šä¼ æ–‡ä»¶</h2>
            <p class="panel-hint">ä¸Šä¼ éœ€è¦åˆå¹¶çš„ Excel æ–‡ä»¶ (æ”¯æŒ .xlsx æ ¼å¼)</p>
            
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">ğŸ“¤</div>
                <p><strong>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</strong> æˆ– <strong>æ‹–æ‹½æ–‡ä»¶</strong>åˆ°æ­¤å¤„</p>
                <p class="upload-hint"><i class="fas fa-info-circle"></i> æ”¯æŒ XLSX, XLS, CSV, JSON æ ¼å¼ï¼Œå¯ä¸€æ¬¡ä¸Šä¼ å¤šä¸ªæ–‡ä»¶</p>
                <input type="file" id="file-input" multiple accept=".xlsx,.xls,.csv,.json" style="display:none">
            </div>
            <div class="file-list" id="file-list"></div>
            
            <div class="wizard-actions">
                <button type="button" class="btn btn-secondary" onclick="previousStep()">
                    <i class="fas fa-arrow-left"></i> ä¸Šä¸€æ­¥
                </button>
                <button type="button" class="btn btn-primary btn-lg" onclick="nextStep()">
                    <i class="fas fa-arrow-right"></i> ä¸‹ä¸€æ­¥
                </button>
            </div>
        </div>

        <!-- æ­¥éª¤ 3: æ•°æ®é¢„è§ˆä¸æ¸…æ´— -->
        <div class="wizard-panel" data-panel="3">
            <h2><i class="fas fa-table"></i> æ•°æ®é¢„è§ˆä¸æ¸…æ´—</h2>
            <p class="panel-hint">é¢„è§ˆä¸Šä¼ çš„æ–‡ä»¶æ•°æ®å¹¶é…ç½®æ¸…æ´—è§„åˆ™ (å¯é€‰)</p>
            
            <!-- æ¨¡æ¿ç®¡ç† -->
            <div class="config-section">
                <h3><i class="fas fa-save"></i> é…ç½®æ¨¡æ¿ç®¡ç†</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">ä¿å­˜å½“å‰é…ç½®ä¸ºæ¨¡æ¿ï¼Œæˆ–åŠ è½½å·²ä¿å­˜çš„é…ç½®</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="template-select">åº”ç”¨æ¨¡æ¿</label>
                        <select id="template-select" class="form-control" onchange="loadSelectedTemplate()">
                            <option value="">-- é€‰æ‹©æ¨¡æ¿ --</option>
                        </select>
                        <small class="form-hint"><i class="fas fa-info-circle"></i> é€‰æ‹©æ¨¡æ¿å°†è‡ªåŠ¨å¡«å……æ‰€æœ‰é…ç½®</small>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-secondary" onclick="loadTemplatesList()">
                            <i class="fas fa-sync"></i> åˆ·æ–°æ¨¡æ¿åˆ—è¡¨
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="template-name-input">ä¿å­˜ä¸ºæ–°æ¨¡æ¿</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="template-name-input" class="form-control" placeholder="è¾“å…¥æ¨¡æ¿åç§°">
                        <button type="button" class="btn btn-primary" onclick="saveCurrentTemplate()">
                            <i class="fas fa-save"></i> ä¿å­˜æ¨¡æ¿
                        </button>
                    </div>
                    <small class="form-hint"><i class="fas fa-lightbulb"></i> å°†å½“å‰æ‰€æœ‰é…ç½®ä¿å­˜ä¸ºå¯å¤ç”¨çš„æ¨¡æ¿</small>
                </div>
            </div>

            <!-- æ–‡ä»¶é¢„è§ˆ -->
            <div class="config-section" style="margin-top: 2rem;">
                <h3><i class="fas fa-eye"></i> æ–‡ä»¶é¢„è§ˆ</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">ç‚¹å‡»æ–‡ä»¶é¢„è§ˆæ•°æ®å‰100è¡Œï¼ŒæŸ¥çœ‹æ•°æ®ç±»å‹å’Œç©ºå€¼ç»Ÿè®¡</p>
                
                <div id="preview-files-list" class="preview-files-list">
                    <!-- åŠ¨æ€ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨ -->
                </div>
            </div>

            <!-- æ•°æ®æ¸…æ´—è§„åˆ™ -->
            <div class="config-section" style="margin-top: 2rem;">
                <h3><i class="fas fa-broom"></i> æ•°æ®æ¸…æ´—è§„åˆ™</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">é…ç½®å»é‡ã€å¡«å……ç©ºå€¼ã€æ ¼å¼æ ‡å‡†åŒ–ç­‰æ¸…æ´—è§„åˆ™</p>
                
                <div id="cleaning-rules-container">
                    <!-- åŠ¨æ€ç”Ÿæˆæ¸…æ´—è§„åˆ™ -->
                </div>
                
                <div class="form-row" style="margin-top: 1rem;">
                    <div class="form-group">
                        <label for="cleaning-rule-type">è§„åˆ™ç±»å‹</label>
                        <select id="cleaning-rule-type" class="form-control">
                            <option value="remove_duplicates">å»é™¤é‡å¤è¡Œ</option>
                            <option value="fill_null">å¡«å……ç©ºå€¼</option>
                            <option value="trim_whitespace">å»é™¤ç©ºæ ¼</option>
                            <option value="standardize_case">æ ‡å‡†åŒ–å¤§å°å†™</option>
                            <option value="standardize_date">æ ‡å‡†åŒ–æ—¥æœŸ</option>
                            <option value="remove_special_chars">ç§»é™¤ç‰¹æ®Šå­—ç¬¦</option>
                            <option value="standardize_phone">æ ‡å‡†åŒ–ç”µè¯å·ç </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cleaning-rule-column">åº”ç”¨åˆ—</label>
                        <input type="text" id="cleaning-rule-column" class="form-control" placeholder="åˆ—å (ç•™ç©º=å…¨éƒ¨)">
                    </div>
                    <div class="form-group">
                        <label for="cleaning-rule-params">å‚æ•° (JSON)</label>
                        <input type="text" id="cleaning-rule-params" class="form-control" placeholder='ä¾‹: {"value": "æœªçŸ¥"}'>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-secondary" onclick="addCleaningRuleToList()">
                            <i class="fas fa-plus"></i> æ·»åŠ è§„åˆ™
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ•°æ®éªŒè¯è§„åˆ™ -->
            <div class="config-section" style="margin-top: 2rem;">
                <h3><i class="fas fa-check-circle"></i> æ•°æ®éªŒè¯è§„åˆ™</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">é…ç½®æ•°æ®ç±»å‹æ£€æŸ¥ã€èŒƒå›´éªŒè¯ã€æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ç­‰è§„åˆ™</p>
                
                <div id="validation-rules-container">
                    <!-- åŠ¨æ€ç”ŸæˆéªŒè¯è§„åˆ™ -->
                </div>
                
                <div class="form-row" style="margin-top: 1rem;">
                    <div class="form-group">
                        <label for="validation-rule-type">éªŒè¯ç±»å‹</label>
                        <select id="validation-rule-type" class="form-control">
                            <option value="type_check">ç±»å‹æ£€æŸ¥</option>
                            <option value="range_check">èŒƒå›´éªŒè¯</option>
                            <option value="regex_match">æ­£åˆ™åŒ¹é…</option>
                            <option value="not_null">éç©ºæ£€æŸ¥</option>
                            <option value="unique">å”¯ä¸€æ€§æ£€æŸ¥</option>
                            <option value="length_check">é•¿åº¦æ£€æŸ¥</option>
                            <option value="enum_check">æšä¸¾å€¼æ£€æŸ¥</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="validation-rule-column">éªŒè¯åˆ— *</label>
                        <input type="text" id="validation-rule-column" class="form-control" placeholder="åˆ—å" required>
                    </div>
                    <div class="form-group">
                        <label for="validation-rule-params">å‚æ•° (JSON)</label>
                        <input type="text" id="validation-rule-params" class="form-control" placeholder='ä¾‹: {"type": "int"}'>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-secondary" onclick="addValidationRuleToList()">
                            <i class="fas fa-plus"></i> æ·»åŠ éªŒè¯
                        </button>
                    </div>
                </div>
                
                <div style="margin-top: 1rem;">
                    <button type="button" class="btn btn-primary" onclick="runDataValidation()">
                        <i class="fas fa-play"></i> è¿è¡Œæ•°æ®éªŒè¯
                    </button>
                    <div id="validation-results" style="margin-top: 1rem;"></div>
                </div>
            </div>
            
            <div class="wizard-actions">
                <button type="button" class="btn btn-secondary" onclick="previousStep()">
                    <i class="fas fa-arrow-left"></i> ä¸Šä¸€æ­¥
                </button>
                <button type="button" class="btn btn-primary btn-lg" onclick="nextStep()">
                    <i class="fas fa-arrow-right"></i> ä¸‹ä¸€æ­¥
                </button>
            </div>
        </div>

        <!-- æ­¥éª¤ 4: é«˜çº§è®¾ç½® -->
        <div class="wizard-panel" data-panel="4">
            <h2><i class="fas fa-magic"></i> é«˜çº§è®¾ç½®</h2>
            <p class="panel-hint">é…ç½®åˆ—æ´¾ç”Ÿè§„åˆ™å’Œå•å…ƒæ ¼æ‰¹é‡æ“ä½œ (å¯é€‰)</p>
            
            <!-- åˆ—æ´¾ç”Ÿè§„åˆ™ -->
            <div class="config-section">
                <h3><i class="fas fa-columns"></i> åˆ—æ´¾ç”Ÿè§„åˆ™</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">æ ¹æ®ç°æœ‰åˆ—çš„å†…å®¹åˆ›å»ºæ–°åˆ—,ä¾‹å¦‚ä»å­¦å·ä¸­æå–ç­çº§ä¿¡æ¯</p>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="enable-column-rule" onchange="toggleColumnRule()" style="width: auto;">
                        <span><strong>å¯ç”¨åˆ—æ´¾ç”Ÿè§„åˆ™</strong></span>
                    </label>
                    <small class="form-hint">
                        <i class="fas fa-lightbulb"></i> ä»å·²æœ‰åˆ—æå–ä¿¡æ¯ç”Ÿæˆæ–°åˆ—,å¦‚ä»å­¦å·"202401001"æå–"01"è½¬ä¸º"ä¸€ç­"
                    </small>
                </div>

                <div id="column-rule-form" style="display:none; margin-top: 1rem;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="source-column">æºåˆ—å *</label>
                            <input type="text" id="source-column" class="form-control" placeholder="ä¾‹å¦‚:å­¦å·">
                        </div>
                        <div class="form-group">
                            <label for="new-column">æ–°åˆ—å *</label>
                            <input type="text" id="new-column" class="form-control" placeholder="ä¾‹å¦‚:ç­çº§">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="enable-extraction" onchange="toggleExtraction()" style="width: auto;">
                            <span>å¯ç”¨å­ä¸²æå–</span>
                        </label>
                        <small class="form-hint"><i class="fas fa-cut"></i> åªæå–æºåˆ—å†…å®¹çš„ä¸€éƒ¨åˆ†</small>
                    </div>
                    
                    <div id="extraction-form" style="display:none; margin-top: 1rem;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="extraction-start">èµ·å§‹ä½ç½®</label>
                                <input type="number" id="extraction-start" class="form-control" placeholder="5" min="1">
                                <small class="form-hint">ç¬¬ä¸€ä¸ªå­—ç¬¦ä½ç½®ä¸º1</small>
                            </div>
                            <div class="form-group">
                                <label for="extraction-end">ç»“æŸä½ç½®</label>
                                <input type="number" id="extraction-end" class="form-control" placeholder="6" min="1">
                                <small class="form-hint">åŒ…å«è¯¥ä½ç½®å­—ç¬¦</small>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="extraction-one-indexed" checked style="width: auto;"> 
                                    1ç´¢å¼•
                                </label>
                            </div>
                        </div>
                    </div>

                    
                    <div style="margin-top: 1rem;">
                        <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">
                            <i class="fas fa-exchange-alt"></i> æ˜ å°„è§„åˆ™ (å°†æå–å€¼è½¬æ¢)
                        </label>
                        <p class="form-hint" style="margin-bottom: 1rem;">
                            ä¾‹å¦‚: "01" â†’ "ä¸€ç­", "02" â†’ "äºŒç­"ã€‚
                            å¿«æ·é”®: <kbd>Tab</kbd> ä¸‹ä¸€ä¸ª | <kbd>Enter</kbd> æ–°å¢ | <kbd>Ctrl+Del</kbd> åˆ é™¤
                        </p>
                        <div id="mappings-container"></div>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addMapping()">
                            <i class="fas fa-plus"></i> æ·»åŠ æ˜ å°„
                        </button>
                    </div>
                </div>
            </div>

            
            <!-- å•å…ƒæ ¼æ‰¹é‡æ“ä½œ -->
            <div class="config-section" style="margin-top: 2rem;">
                <h3><i class="fas fa-edit"></i> å•å…ƒæ ¼æ‰¹é‡æ“ä½œ</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">å¯¹æŒ‡å®šåˆ—çš„æ‰€æœ‰å•å…ƒæ ¼è¿›è¡Œç»Ÿä¸€ä¿®æ”¹</p>
                
                <p class="form-hint" style="margin-bottom: 1rem;">
                    <i class="fas fa-keyboard"></i> å¿«æ·é”®: <kbd>Tab</kbd> ä¸‹ä¸€ä¸ª | <kbd>Enter</kbd> æ–°å¢ | <kbd>Ctrl+Del</kbd> åˆ é™¤
                </p>
                
                <div id="operations-container"></div>
                <button type="button" class="btn btn-sm btn-secondary" onclick="addOperation()">
                    <i class="fas fa-plus"></i> æ·»åŠ æ“ä½œ
                </button>
            </div>

            <div class="wizard-actions">
                <button type="button" class="btn btn-secondary" onclick="previousStep()">
                    <i class="fas fa-arrow-left"></i> ä¸Šä¸€æ­¥
                </button>
                <button type="button" class="btn btn-primary btn-lg" onclick="saveAllAndNext()">
                    <i class="fas fa-arrow-right"></i> ä¸‹ä¸€æ­¥
                </button>
            </div>
        </div>

        <!-- æ­¥éª¤ 5: ç¡®è®¤æ‰§è¡Œ -->
        <div class="wizard-panel" data-panel="5">
            <h2><i class="fas fa-check-circle"></i> ç¡®è®¤æ‰§è¡Œ</h2>
            <div class="summary">
                <h3><i class="fas fa-list-check"></i> ä»»åŠ¡é…ç½®æ±‡æ€»</h3>
                <div class="summary-item">
                    <span class="summary-label">ä»»åŠ¡åç§°:</span>
                    <span id="summary-name"></span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">è¾“å‡ºæ ¼å¼:</span>
                    <span id="summary-format"></span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">æ–‡ä»¶æ•°é‡:</span>
                    <span id="summary-files"></span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">åˆ—è¿‡æ»¤:</span>
                    <span id="summary-filter"></span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">æ¸…æ´—è§„åˆ™:</span>
                    <span id="summary-cleaning"></span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">éªŒè¯è§„åˆ™:</span>
                    <span id="summary-validation"></span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">åˆ—è§„åˆ™:</span>
                    <span id="summary-rule"></span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">æ“ä½œæ•°é‡:</span>
                    <span id="summary-ops"></span>
                </div>
            </div>

            <div id="process-status" class="process-status"></div>

            <div class="wizard-actions">
                <button type="button" class="btn btn-secondary" onclick="previousStep()">
                    <i class="fas fa-arrow-left"></i> ä¸Šä¸€æ­¥
                </button>
                <button type="button" class="btn btn-success btn-lg" id="process-btn" onclick="processTask()">
                    <i class="fas fa-play"></i> å¼€å§‹å¤„ç†
                </button>
                <button type="button" class="btn btn-info" onclick="generateChartsForTask()" style="margin-left: 1rem;">
                    <i class="fas fa-chart-bar"></i> ç”Ÿæˆç»Ÿè®¡å›¾è¡¨
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentTaskId = null;
let currentStep = 1;
let uploadedFiles = [];
let mappings = [];
let operations = [];
let cleaningRulesList = [];
let validationRulesList = [];

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥URLå‚æ•°
window.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const taskId = urlParams.get('task_id');
    
    if (taskId) {
        loadExistingTask(taskId);
    }
    
    // åŠ è½½æ¨¡æ¿åˆ—è¡¨
    loadTemplatesList();
});

// æ­¥éª¤å¯¼èˆª
function nextStep() {
    if (currentStep < 5) {
        currentStep++;
        updateWizard();
        
        // è¿›å…¥æ­¥éª¤3æ—¶ï¼Œæ›´æ–°æ–‡ä»¶é¢„è§ˆåˆ—è¡¨
        if (currentStep === 3) {
            updatePreviewFilesList();
        }
    }
}

function previousStep() {
    if (currentStep > 1) {
        currentStep--;
        updateWizard();
    }
}

function updateWizard() {
    document.querySelectorAll('.wizard-step').forEach(step => {
        const stepNum = parseInt(step.dataset.step);
        step.classList.toggle('active', stepNum === currentStep);
        step.classList.toggle('completed', stepNum < currentStep);
    });
    
    document.querySelectorAll('.wizard-panel').forEach(panel => {
        panel.classList.toggle('active', parseInt(panel.dataset.panel) === currentStep);
    });

    if (currentStep === 5) {
        updateSummary();
    }
}

// åˆ‡æ¢åˆ—è¿‡æ»¤è¡¨å•æ˜¾ç¤º
function toggleFilterColumns() {
    const filterMode = document.getElementById('filter-mode').value;
    const filterColumnsForm = document.getElementById('filter-columns-form');
    filterColumnsForm.style.display = (filterMode === 'none') ? 'none' : 'block';
}

// åˆ‡æ¢åˆ—æ´¾ç”Ÿè§„åˆ™è¡¨å•æ˜¾ç¤º
function toggleColumnRule() {
    const form = document.getElementById('column-rule-form');
    const button = event.target;
    if (form.style.display === 'none') {
        form.style.display = 'block';
        button.textContent = 'éšè—é…ç½®è¡¨å•';
    } else {
        form.style.display = 'none';
        button.textContent = 'æ˜¾ç¤ºé…ç½®è¡¨å•';
    }
}

// åˆ‡æ¢æå–è§„åˆ™è¡¨å•æ˜¾ç¤º
function toggleExtraction() {
    const form = document.getElementById('extraction-form');
    const button = event.target;
    if (form.style.display === 'none') {
        form.style.display = 'block';
        button.textContent = 'éšè—æå–è§„åˆ™';
    } else {
        form.style.display = 'none';
        button.textContent = 'æ˜¾ç¤ºæå–è§„åˆ™';
    }
}

// åˆ›å»ºä»»åŠ¡
function createTask() {
    // å¦‚æœå·²æœ‰ä»»åŠ¡ID,ç›´æ¥è·³åˆ°ä¸‹ä¸€æ­¥
    if (currentTaskId) {
        nextStep();
        return;
    }
    
    const name = document.getElementById('task-name').value.trim();
    if (!name) {
        alert('è¯·è¾“å…¥ä»»åŠ¡åç§°');
        return;
    }

    const outputFormat = document.getElementById('output-format').value;
    const filterMode = document.getElementById('filter-mode').value;
    
    // è·å–åˆ—è¿‡æ»¤åˆ—è¡¨
    let filterColumns = [];
    if (filterMode !== 'none') {
        const columnsText = document.getElementById('filter-columns').value.trim();
        if (columnsText) {
            filterColumns = columnsText.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
        }
    }

    fetch('/api/tasks/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ 
            name, 
            output_format: outputFormat,
            filter_mode: filterMode,
            filter_columns: filterColumns
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentTaskId = data.task_id;
            nextStep();
        } else {
            alert('åˆ›å»ºä»»åŠ¡å¤±è´¥: ' + data.error);
        }
    })
    .catch(error => {
        alert('åˆ›å»ºä»»åŠ¡å¤±è´¥: ' + error);
    });
}

// æ–‡ä»¶ä¸Šä¼ äº‹ä»¶ç»‘å®š
document.addEventListener('DOMContentLoaded', function() {
    
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');

    uploadArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFiles);

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        handleFiles({ target: { files: e.dataTransfer.files } });
    });

    // åˆ—è§„åˆ™å¼€å…³
    document.getElementById('enable-column-rule').addEventListener('change', function() {
        document.getElementById('column-rule-form').style.display = this.checked ? 'block' : 'none';
    });

    document.getElementById('enable-extraction').addEventListener('change', function() {
        document.getElementById('extraction-form').style.display = this.checked ? 'block' : 'none';
    });
});

function handleFiles(e) {
    const files = Array.from(e.target.files);
    const formData = new FormData();
    formData.append('task_id', currentTaskId);
    
    files.forEach(file => {
        formData.append('files', file);
    });

    fetch(`/api/tasks/${currentTaskId}/upload/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            uploadedFiles = uploadedFiles.concat(data.files);
            updateFileList();
        } else {
            alert('ä¸Šä¼ å¤±è´¥: ' + data.error);
        }
    });
}

function updateFileList() {
    const fileList = document.getElementById('file-list');
    fileList.innerHTML = uploadedFiles.map(file => `
        <div class="file-item">
            <span class="file-icon">ğŸ“„</span>
            <span class="file-name">${file.name}</span>
            <button type="button" class="btn btn-sm btn-danger" onclick="deleteFile(${file.id})">åˆ é™¤</button>
        </div>
    `).join('');
}

function deleteFile(fileId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—?')) return;
    
    fetch(`/api/files/${fileId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            uploadedFiles = uploadedFiles.filter(f => f.id !== fileId);
            updateFileList();
        } else {
            alert('åˆ é™¤å¤±è´¥: ' + data.error);
        }
    });
}

// åˆ—è§„åˆ™
function addMapping() {
    const container = document.getElementById('mappings-container');
    const index = mappings.length;
    const div = document.createElement('div');
    div.className = 'mapping-item';
    div.innerHTML = `
        <input type="text" placeholder="æ¨¡å¼" class="form-control mapping-pattern" data-index="${index}" onkeydown="handleMappingKeydown(event, ${index}, 'pattern')">
        <input type="text" placeholder="å€¼" class="form-control mapping-value" data-index="${index}" onkeydown="handleMappingKeydown(event, ${index}, 'value')">
        <button type="button" class="btn btn-sm btn-danger" onclick="removeMapping(${index})">åˆ é™¤</button>
    `;
    container.appendChild(div);
    mappings.push({ pattern: '', value: '' });
    
    // è‡ªåŠ¨èšç„¦åˆ°æ–°æ·»åŠ çš„æ¨¡å¼è¾“å…¥æ¡†
    setTimeout(() => {
        const newInput = div.querySelector('.mapping-pattern');
        if (newInput) newInput.focus();
    }, 0);
}

function removeMapping(index) {
    const items = document.querySelectorAll('.mapping-item');
    if (items.length > 0 && items[index]) {
        items[index].remove();
        mappings.splice(index, 1);
        // æ›´æ–°å‰©ä½™é¡¹çš„ç´¢å¼•
        updateMappingIndices();
    }
}

// åœ¨æŒ‡å®šç´¢å¼•åæ’å…¥æ–°çš„æ˜ å°„è¡Œ
function insertMappingAfter(index) {
    const container = document.getElementById('mappings-container');
    const items = Array.from(document.querySelectorAll('.mapping-item'));
    const newIndex = index + 1;
    
    const div = document.createElement('div');
    div.className = 'mapping-item';
    div.innerHTML = `
        <input type="text" placeholder="æ¨¡å¼" class="form-control mapping-pattern" data-index="${newIndex}" onkeydown="handleMappingKeydown(event, ${newIndex}, 'pattern')">
        <input type="text" placeholder="å€¼" class="form-control mapping-value" data-index="${newIndex}" onkeydown="handleMappingKeydown(event, ${newIndex}, 'value')">
        <button type="button" class="btn btn-sm btn-danger" onclick="removeMapping(${newIndex})">åˆ é™¤</button>
    `;
    
    // åœ¨æŒ‡å®šä½ç½®æ’å…¥
    if (index < items.length - 1) {
        items[index].after(div);
    } else {
        container.appendChild(div);
    }
    
    mappings.splice(newIndex, 0, { pattern: '', value: '' });
    updateMappingIndices();
    
    // èšç„¦åˆ°æ–°è¡Œçš„æ¨¡å¼è¾“å…¥æ¡†
    setTimeout(() => {
        const newInput = div.querySelector('.mapping-pattern');
        if (newInput) newInput.focus();
    }, 0);
}

// æ›´æ–°æ‰€æœ‰æ˜ å°„é¡¹çš„ç´¢å¼•
function updateMappingIndices() {
    const items = document.querySelectorAll('.mapping-item');
    items.forEach((item, idx) => {
        const patternInput = item.querySelector('.mapping-pattern');
        const valueInput = item.querySelector('.mapping-value');
        const deleteBtn = item.querySelector('button');
        
        if (patternInput) {
            patternInput.setAttribute('data-index', idx);
            patternInput.setAttribute('onkeydown', `handleMappingKeydown(event, ${idx}, 'pattern')`);
        }
        if (valueInput) {
            valueInput.setAttribute('data-index', idx);
            valueInput.setAttribute('onkeydown', `handleMappingKeydown(event, ${idx}, 'value')`);
        }
        if (deleteBtn) {
            deleteBtn.setAttribute('onclick', `removeMapping(${idx})`);
        }
    });
}

// å¤„ç†é”®ç›˜äº‹ä»¶,å®ç°ç±»ä¼¼Excelçš„å¯¼èˆªå’Œè‡ªåŠ¨å¡«å……
function handleMappingKeydown(event, index, field) {
    const items = document.querySelectorAll('.mapping-item');
    const currentItem = items[index];
    if (!currentItem) return;
    
    // Tabé”®:ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªè¾“å…¥æ¡†,å¦‚æœæ˜¯æœ€åä¸€ä¸ªå€¼è¾“å…¥æ¡†åˆ™è‡ªåŠ¨æ·»åŠ æ–°è¡Œ
    if (event.key === 'Tab' && !event.shiftKey) {
        if (field === 'value') {
            event.preventDefault();
            // å¦‚æœæ˜¯æœ€åä¸€è¡Œ,æ·»åŠ æ–°è¡Œ
            if (index === items.length - 1) {
                addMapping();
            } else {
                // å¦åˆ™ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œçš„æ¨¡å¼è¾“å…¥æ¡†
                const nextItem = items[index + 1];
                const nextInput = nextItem?.querySelector('.mapping-pattern');
                if (nextInput) nextInput.focus();
            }
        }
        // å¦‚æœæ˜¯æ¨¡å¼è¾“å…¥æ¡†,é»˜è®¤è¡Œä¸ºä¼šç§»åŠ¨åˆ°å€¼è¾“å…¥æ¡†
    }
    
    // Shift+Tabé”®:ç§»åŠ¨åˆ°ä¸Šä¸€ä¸ªè¾“å…¥æ¡†
    if (event.key === 'Tab' && event.shiftKey) {
        if (field === 'pattern' && index > 0) {
            event.preventDefault();
            const prevItem = items[index - 1];
            const prevInput = prevItem?.querySelector('.mapping-value');
            if (prevInput) prevInput.focus();
        }
    }
    
    // Enteré”®:ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œæˆ–æ·»åŠ æ–°è¡Œ
    if (event.key === 'Enter') {
        event.preventDefault();
        if (field === 'pattern') {
            // åœ¨æ¨¡å¼è¾“å…¥æ¡†æŒ‰Enter,ç§»åŠ¨åˆ°å€¼è¾“å…¥æ¡†
            const valueInput = currentItem.querySelector('.mapping-value');
            if (valueInput) valueInput.focus();
        } else {
            // åœ¨å€¼è¾“å…¥æ¡†æŒ‰Enter,ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œæˆ–æ·»åŠ æ–°è¡Œ
            if (index === items.length - 1) {
                addMapping();
            } else {
                const nextItem = items[index + 1];
                const nextInput = nextItem?.querySelector('.mapping-pattern');
                if (nextInput) nextInput.focus();
            }
        }
    }
    
    // æ–¹å‘é”®ä¸Š:ç§»åŠ¨åˆ°ä¸Šä¸€è¡Œ
    if (event.key === 'ArrowUp') {
        event.preventDefault();
        if (index > 0) {
            const prevItem = items[index - 1];
            const prevInput = prevItem?.querySelector(`.mapping-${field}`);
            if (prevInput) prevInput.focus();
        }
    }
    
    // æ–¹å‘é”®ä¸‹:ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œ
    if (event.key === 'ArrowDown') {
        event.preventDefault();
        if (index < items.length - 1) {
            const nextItem = items[index + 1];
            const nextInput = nextItem?.querySelector(`.mapping-${field}`);
            if (nextInput) nextInput.focus();
        } else {
            // å¦‚æœæ˜¯æœ€åä¸€è¡Œ,æ·»åŠ æ–°è¡Œ
            addMapping();
        }
    }
    
    // æ–¹å‘é”®å·¦:ç§»åŠ¨åˆ°æ¨¡å¼è¾“å…¥æ¡†(ä»…å½“å…‰æ ‡åœ¨å¼€å¤´æ—¶)
    if (event.key === 'ArrowLeft' && field === 'value' && event.target.selectionStart === 0) {
        event.preventDefault();
        const patternInput = currentItem.querySelector('.mapping-pattern');
        if (patternInput) {
            patternInput.focus();
            patternInput.selectionStart = patternInput.value.length;
            patternInput.selectionEnd = patternInput.value.length;
        }
    }
    
    // æ–¹å‘é”®å³:ç§»åŠ¨åˆ°å€¼è¾“å…¥æ¡†(ä»…å½“å…‰æ ‡åœ¨æœ«å°¾æ—¶)
    if (event.key === 'ArrowRight' && field === 'pattern' && 
        event.target.selectionStart === event.target.value.length) {
        event.preventDefault();
        const valueInput = currentItem.querySelector('.mapping-value');
        if (valueInput) {
            valueInput.focus();
            valueInput.selectionStart = 0;
            valueInput.selectionEnd = 0;
        }
    }
    
    // Ctrl+Delete:åˆ é™¤å½“å‰è¡Œ(ä½†è‡³å°‘ä¿ç•™ä¸€è¡Œ)
    if (event.key === 'Delete' && event.ctrlKey && items.length > 1) {
        event.preventDefault();
        removeMapping(index);
        // èšç„¦åˆ°ä¸Šä¸€è¡Œæˆ–ä¸‹ä¸€è¡Œ
        const nextIndex = index > 0 ? index - 1 : 0;
        setTimeout(() => {
            const nextItem = document.querySelectorAll('.mapping-item')[nextIndex];
            if (nextItem) {
                const focusInput = nextItem.querySelector(`.mapping-${field}`);
                if (focusInput) focusInput.focus();
            }
        }, 0);
    }
    
    // Ctrl+Enter:å¿«é€Ÿåœ¨å½“å‰è¡Œä¸‹æ–¹æ’å…¥æ–°è¡Œ
    if (event.key === 'Enter' && event.ctrlKey) {
        event.preventDefault();
        insertMappingAfter(index);
    }
}

// ä¿å­˜åˆ—è§„åˆ™å’Œå•å…ƒæ ¼æ“ä½œ,ç„¶åè¿›å…¥ä¸‹ä¸€æ­¥
function saveAllAndNext() {
    const promises = [];
    
    // ä¿å­˜åˆ—æ´¾ç”Ÿè§„åˆ™
    if (document.getElementById('enable-column-rule').checked) {
        const sourceColumn = document.getElementById('source-column').value;
        const newColumn = document.getElementById('new-column').value;

        if (!sourceColumn || !newColumn) {
            alert('è¯·å¡«å†™æºåˆ—åå’Œæ–°åˆ—å');
            return;
        }

        const mappingElements = document.querySelectorAll('.mapping-pattern');
        const mappings = Array.from(mappingElements).map((el, i) => ({
            pattern: el.value,
            value: document.querySelectorAll('.mapping-value')[i].value
        })).filter(m => m.pattern && m.value);

        const ruleData = {
            name: 'åˆ—è§„åˆ™',
            source_column: sourceColumn,
            new_column: newColumn,
            mappings: mappings
        };

        if (document.getElementById('enable-extraction').checked) {
            ruleData.extraction_start = parseInt(document.getElementById('extraction-start').value);
            ruleData.extraction_end = parseInt(document.getElementById('extraction-end').value);
            ruleData.extraction_one_indexed = document.getElementById('extraction-one-indexed').checked;
        }

        promises.push(
            fetch(`/api/tasks/${currentTaskId}/column-rule/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(ruleData)
            }).then(response => response.json())
        );
    }
    
    // ä¿å­˜å•å…ƒæ ¼æ“ä½œ
    const opElements = document.querySelectorAll('.operation-item');
    const operations = Array.from(opElements).map((el, i) => {
        const column = el.querySelector('.op-column').value;
        const action = el.querySelector('.op-action').value;
        const value = el.querySelector('.op-value').value;
        return { column, action, value };
    }).filter(op => op.column);

    if (operations.length > 0) {
        promises.push(
            fetch(`/api/tasks/${currentTaskId}/cell-operations/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ operations: operations })
            }).then(response => response.json())
        );
    }
    
    // å¦‚æœæœ‰ä»»ä½•éœ€è¦ä¿å­˜çš„é…ç½®
    if (promises.length > 0) {
        Promise.all(promises)
            .then(results => {
                const allSuccess = results.every(data => data.success);
                if (allSuccess) {
                    nextStep();
                } else {
                    const errors = results.filter(d => !d.success).map(d => d.error);
                    alert('ä¿å­˜é…ç½®å¤±è´¥: ' + errors.join(', '));
                }
            })
            .catch(error => {
                alert('ä¿å­˜é…ç½®å¤±è´¥: ' + error);
            });
    } else {
        nextStep();
    }
}

// å•å…ƒæ ¼æ“ä½œ
function addOperation() {
    const container = document.getElementById('operations-container');
    const index = operations.length;
    const div = document.createElement('div');
    div.className = 'operation-item';
    div.innerHTML = `
        <div class="form-row">
            <input type="text" placeholder="åˆ—å" class="form-control op-column" data-index="${index}" onkeydown="handleOperationKeydown(event, ${index}, 'column')">
            <select class="form-control op-action" data-index="${index}" onkeydown="handleOperationKeydown(event, ${index}, 'action')">
                <option value="add_prefix">æ·»åŠ å‰ç¼€</option>
                <option value="add_suffix">æ·»åŠ åç¼€</option>
                <option value="remove_prefix">åˆ é™¤å‰ç¼€</option>
                <option value="remove_suffix">åˆ é™¤åç¼€</option>
                <option value="replace">æ›¿æ¢æ–‡æœ¬</option>
            </select>
            <input type="text" placeholder="å€¼" class="form-control op-value" data-index="${index}" onkeydown="handleOperationKeydown(event, ${index}, 'value')">
            <button type="button" class="btn btn-sm btn-danger" onclick="removeOperation(${index})">åˆ é™¤</button>
        </div>
    `;
    container.appendChild(div);
    operations.push({});
    
    // è‡ªåŠ¨èšç„¦åˆ°æ–°æ·»åŠ çš„åˆ—åè¾“å…¥æ¡†
    setTimeout(() => {
        const newInput = div.querySelector('.op-column');
        if (newInput) newInput.focus();
    }, 0);
}

function removeOperation(index) {
    const items = document.querySelectorAll('.operation-item');
    if (items.length > 0 && items[index]) {
        items[index].remove();
        operations.splice(index, 1);
        // æ›´æ–°å‰©ä½™é¡¹çš„ç´¢å¼•
        updateOperationIndices();
    }
}

// åœ¨æŒ‡å®šç´¢å¼•åæ’å…¥æ–°çš„æ“ä½œè¡Œ
function insertOperationAfter(index) {
    const container = document.getElementById('operations-container');
    const items = Array.from(document.querySelectorAll('.operation-item'));
    const newIndex = index + 1;
    
    const div = document.createElement('div');
    div.className = 'operation-item';
    div.innerHTML = `
        <div class="form-row">
            <input type="text" placeholder="åˆ—å" class="form-control op-column" data-index="${newIndex}" onkeydown="handleOperationKeydown(event, ${newIndex}, 'column')">
            <select class="form-control op-action" data-index="${newIndex}" onkeydown="handleOperationKeydown(event, ${newIndex}, 'action')">
                <option value="add_prefix">æ·»åŠ å‰ç¼€</option>
                <option value="add_suffix">æ·»åŠ åç¼€</option>
                <option value="remove_prefix">åˆ é™¤å‰ç¼€</option>
                <option value="remove_suffix">åˆ é™¤åç¼€</option>
                <option value="replace">æ›¿æ¢æ–‡æœ¬</option>
            </select>
            <input type="text" placeholder="å€¼" class="form-control op-value" data-index="${newIndex}" onkeydown="handleOperationKeydown(event, ${newIndex}, 'value')">
            <button type="button" class="btn btn-sm btn-danger" onclick="removeOperation(${newIndex})">åˆ é™¤</button>
        </div>
    `;
    
    // åœ¨æŒ‡å®šä½ç½®æ’å…¥
    if (index < items.length - 1) {
        items[index].after(div);
    } else {
        container.appendChild(div);
    }
    
    operations.splice(newIndex, 0, {});
    updateOperationIndices();
    
    // èšç„¦åˆ°æ–°è¡Œçš„åˆ—åè¾“å…¥æ¡†
    setTimeout(() => {
        const newInput = div.querySelector('.op-column');
        if (newInput) newInput.focus();
    }, 0);
}

// æ›´æ–°æ‰€æœ‰æ“ä½œé¡¹çš„ç´¢å¼•
function updateOperationIndices() {
    const items = document.querySelectorAll('.operation-item');
    items.forEach((item, idx) => {
        const columnInput = item.querySelector('.op-column');
        const actionSelect = item.querySelector('.op-action');
        const valueInput = item.querySelector('.op-value');
        const deleteBtn = item.querySelector('button');
        
        if (columnInput) {
            columnInput.setAttribute('data-index', idx);
            columnInput.setAttribute('onkeydown', `handleOperationKeydown(event, ${idx}, 'column')`);
        }
        if (actionSelect) {
            actionSelect.setAttribute('data-index', idx);
            actionSelect.setAttribute('onkeydown', `handleOperationKeydown(event, ${idx}, 'action')`);
        }
        if (valueInput) {
            valueInput.setAttribute('data-index', idx);
            valueInput.setAttribute('onkeydown', `handleOperationKeydown(event, ${idx}, 'value')`);
        }
        if (deleteBtn) {
            deleteBtn.setAttribute('onclick', `removeOperation(${idx})`);
        }
    });
}

// å¤„ç†å•å…ƒæ ¼æ“ä½œçš„é”®ç›˜äº‹ä»¶ - ç±»ä¼¼Excelçš„å¯¼èˆª
function handleOperationKeydown(event, index, field) {
    const items = document.querySelectorAll('.operation-item');
    const currentItem = items[index];
    if (!currentItem) return;
    
    // Tabé”®:ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªè¾“å…¥æ¡†
    if (event.key === 'Tab' && !event.shiftKey) {
        if (field === 'value') {
            event.preventDefault();
            // å¦‚æœæ˜¯æœ€åä¸€è¡Œ,æ·»åŠ æ–°è¡Œ
            if (index === items.length - 1) {
                addOperation();
            } else {
                // å¦åˆ™ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œçš„åˆ—åè¾“å…¥æ¡†
                const nextItem = items[index + 1];
                const nextInput = nextItem?.querySelector('.op-column');
                if (nextInput) nextInput.focus();
            }
        }
    }
    
    // Shift+Tabé”®:ç§»åŠ¨åˆ°ä¸Šä¸€ä¸ªè¾“å…¥æ¡†
    if (event.key === 'Tab' && event.shiftKey) {
        if (field === 'column' && index > 0) {
            event.preventDefault();
            const prevItem = items[index - 1];
            const prevInput = prevItem?.querySelector('.op-value');
            if (prevInput) prevInput.focus();
        }
    }
    
    // Enteré”®:ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå­—æ®µæˆ–ä¸‹ä¸€è¡Œ
    if (event.key === 'Enter') {
        event.preventDefault();
        if (field === 'column') {
            const actionSelect = currentItem.querySelector('.op-action');
            if (actionSelect) actionSelect.focus();
        } else if (field === 'action') {
            const valueInput = currentItem.querySelector('.op-value');
            if (valueInput) valueInput.focus();
        } else if (field === 'value') {
            // åœ¨å€¼è¾“å…¥æ¡†æŒ‰Enter,ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œæˆ–æ·»åŠ æ–°è¡Œ
            if (index === items.length - 1) {
                addOperation();
            } else {
                const nextItem = items[index + 1];
                const nextInput = nextItem?.querySelector('.op-column');
                if (nextInput) nextInput.focus();
            }
        }
    }
    
    // æ–¹å‘é”®ä¸Š:ç§»åŠ¨åˆ°ä¸Šä¸€è¡Œ
    if (event.key === 'ArrowUp') {
        event.preventDefault();
        if (index > 0) {
            const prevItem = items[index - 1];
            const prevInput = prevItem?.querySelector(`.op-${field}`);
            if (prevInput) prevInput.focus();
        }
    }
    
    // æ–¹å‘é”®ä¸‹:ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œ
    if (event.key === 'ArrowDown') {
        event.preventDefault();
        if (index < items.length - 1) {
            const nextItem = items[index + 1];
            const nextInput = nextItem?.querySelector(`.op-${field}`);
            if (nextInput) nextInput.focus();
        } else {
            // å¦‚æœæ˜¯æœ€åä¸€è¡Œ,æ·»åŠ æ–°è¡Œ
            addOperation();
        }
    }
    
    // æ–¹å‘é”®å·¦:ç§»åŠ¨åˆ°ä¸Šä¸€ä¸ªå­—æ®µ(ä»…å½“å…‰æ ‡åœ¨å¼€å¤´æ—¶)
    if (event.key === 'ArrowLeft' && event.target.selectionStart === 0) {
        event.preventDefault();
        if (field === 'action') {
            const columnInput = currentItem.querySelector('.op-column');
            if (columnInput) {
                columnInput.focus();
                columnInput.selectionStart = columnInput.value.length;
                columnInput.selectionEnd = columnInput.value.length;
            }
        } else if (field === 'value') {
            const actionSelect = currentItem.querySelector('.op-action');
            if (actionSelect) actionSelect.focus();
        }
    }
    
    // æ–¹å‘é”®å³:ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå­—æ®µ(ä»…å½“å…‰æ ‡åœ¨æœ«å°¾æ—¶)
    if (event.key === 'ArrowRight') {
        const atEnd = field === 'action' || 
                     (event.target.selectionStart === event.target.value.length);
        if (atEnd) {
            event.preventDefault();
            if (field === 'column') {
                const actionSelect = currentItem.querySelector('.op-action');
                if (actionSelect) actionSelect.focus();
            } else if (field === 'action') {
                const valueInput = currentItem.querySelector('.op-value');
                if (valueInput) {
                    valueInput.focus();
                    valueInput.selectionStart = 0;
                    valueInput.selectionEnd = 0;
                }
            }
        }
    }
    
    // Ctrl+Delete:åˆ é™¤å½“å‰è¡Œ(ä½†è‡³å°‘ä¿ç•™ä¸€è¡Œ)
    if (event.key === 'Delete' && event.ctrlKey && items.length > 1) {
        event.preventDefault();
        removeOperation(index);
        // èšç„¦åˆ°ä¸Šä¸€è¡Œæˆ–ä¸‹ä¸€è¡Œ
        const nextIndex = index > 0 ? index - 1 : 0;
        setTimeout(() => {
            const nextItem = document.querySelectorAll('.operation-item')[nextIndex];
            if (nextItem) {
                const focusInput = nextItem.querySelector(`.op-${field}`);
                if (focusInput) focusInput.focus();
            }
        }, 0);
    }
    
    // Ctrl+Enter:å¿«é€Ÿåœ¨å½“å‰è¡Œä¸‹æ–¹æ’å…¥æ–°è¡Œ
    if (event.key === 'Enter' && event.ctrlKey) {
        event.preventDefault();
        insertOperationAfter(index);
    }
}



// æ±‡æ€»
function updateSummary() {
    document.getElementById('summary-name').textContent = document.getElementById('task-name').value;
    document.getElementById('summary-format').textContent = document.getElementById('output-format').value.toUpperCase();
    document.getElementById('summary-files').textContent = uploadedFiles.length + ' ä¸ªæ–‡ä»¶';
    
    // åˆ—è¿‡æ»¤ä¿¡æ¯
    const filterMode = document.getElementById('filter-mode').value;
    const filterModeText = {
        'none': 'ä¸è¿‡æ»¤',
        'keep': 'åªä¿ç•™æŒ‡å®šåˆ—',
        'remove': 'åˆ é™¤æŒ‡å®šåˆ—'
    };
    let filterText = filterModeText[filterMode] || 'ä¸è¿‡æ»¤';
    if (filterMode !== 'none') {
        const columnsText = document.getElementById('filter-columns').value.trim();
        const columnCount = columnsText ? columnsText.split('\n').filter(l => l.trim()).length : 0;
        filterText += ` (${columnCount}åˆ—)`;
    }
    document.getElementById('summary-filter').textContent = filterText;
    
    // æ¸…æ´—è§„åˆ™ä¿¡æ¯
    document.getElementById('summary-cleaning').textContent = cleaningRulesList.length > 0 ? 
        `${cleaningRulesList.length} ä¸ªè§„åˆ™` : 'æœªé…ç½®';
    
    // éªŒè¯è§„åˆ™ä¿¡æ¯
    document.getElementById('summary-validation').textContent = validationRulesList.length > 0 ? 
        `${validationRulesList.length} ä¸ªè§„åˆ™` : 'æœªé…ç½®';
    
    document.getElementById('summary-rule').textContent = document.getElementById('enable-column-rule').checked ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨';
    document.getElementById('summary-ops').textContent = document.querySelectorAll('.operation-item').length + ' ä¸ªæ“ä½œ';
}

// å¤„ç†ä»»åŠ¡
function processTask() {
    const btn = document.getElementById('process-btn');
    btn.disabled = true;
    btn.textContent = 'å¤„ç†ä¸­...';

    const statusDiv = document.getElementById('process-status');
    statusDiv.innerHTML = '<div class="processing">æ­£åœ¨å¤„ç†,è¯·ç¨å€™...</div>';

    fetch(`/api/tasks/${currentTaskId}/process/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = `
                <div class="success">
                    <h3>âœ… å¤„ç†å®Œæˆ!</h3>
                    <p><a href="${data.download_url}" class="btn btn-success">ä¸‹è½½ç»“æœæ–‡ä»¶</a></p>
                    <p><a href="/tasks/${currentTaskId}/" class="btn btn-secondary">æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…</a></p>
                </div>
            `;
        } else {
            statusDiv.innerHTML = `<div class="error">å¤„ç†å¤±è´¥: ${data.error}</div>`;
            btn.disabled = false;
            btn.textContent = 'é‡æ–°å¤„ç†';
        }
    })
    .catch(error => {
        statusDiv.innerHTML = `<div class="error">å¤„ç†å¤±è´¥: ${error}</div>`;
        btn.disabled = false;
        btn.textContent = 'é‡æ–°å¤„ç†';
    });
}

// è·å– CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// åŠ è½½å·²æœ‰ä»»åŠ¡
function loadExistingTask(taskId) {
    fetch(`/api/tasks/${taskId}/status/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const task = data.task;
                
                // è®¾ç½®ä»»åŠ¡ID
                currentTaskId = task.id;
                
                // å¡«å……ä»»åŠ¡ä¿¡æ¯
                document.getElementById('task-name').value = task.name;
                document.getElementById('output-format').value = task.output_format;
                
                // å¡«å……åˆ—è¿‡æ»¤é…ç½®
                if (task.filter_mode) {
                    document.getElementById('filter-mode').value = task.filter_mode;
                    toggleFilterColumns();
                    if (task.filter_columns && task.filter_columns.length > 0) {
                        document.getElementById('filter-columns').value = task.filter_columns.join('\n');
                    }
                }
                
                // å¡«å……æ–‡ä»¶åˆ—è¡¨
                uploadedFiles = task.files;
                updateFileList();
                
                // å¡«å……åˆ—è§„åˆ™
                if (task.column_rule) {
                    const rule = task.column_rule;
                    document.getElementById('enable-column-rule').checked = true;
                    document.getElementById('column-rule-form').style.display = 'block';
                    document.getElementById('source-column').value = rule.source_column;
                    document.getElementById('new-column').value = rule.new_column;
                    
                    if (rule.extraction_start !== null) {
                        document.getElementById('enable-extraction').checked = true;
                        document.getElementById('extraction-form').style.display = 'block';
                        document.getElementById('extraction-start').value = rule.extraction_start;
                        document.getElementById('extraction-end').value = rule.extraction_end;
                        document.getElementById('extraction-one-indexed').checked = rule.extraction_one_indexed;
                    }
                    
                    // å¡«å……æ˜ å°„è§„åˆ™
                    rule.mappings.forEach(mapping => {
                        addMapping();
                        const index = mappings.length - 1;
                        document.querySelectorAll('.mapping-pattern')[index].value = mapping.pattern;
                        document.querySelectorAll('.mapping-value')[index].value = mapping.value;
                    });
                }
                
                // å¡«å……å•å…ƒæ ¼æ“ä½œ
                task.operations.forEach(op => {
                    addOperation();
                    const index = operations.length - 1;
                    const opItem = document.querySelectorAll('.operation-item')[index];
                    opItem.querySelector('.op-column').value = op.column;
                    opItem.querySelector('.op-action').value = op.action;
                    opItem.querySelector('.op-value').value = op.value || '';
                });
                
                alert('å·²åŠ è½½ä»»åŠ¡æ•°æ®,å¯ä»¥ç»§ç»­ä¿®æ”¹é…ç½®å¹¶å¤„ç†');
            } else {
                alert('åŠ è½½ä»»åŠ¡å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            alert('åŠ è½½ä»»åŠ¡å¤±è´¥: ' + error);
        });
}

// ========== æ–°å¢åŠŸèƒ½å‡½æ•° ==========

// æ¨¡æ¿ç®¡ç†
async function loadTemplatesList() {
    try {
        const response = await fetch('/api/templates/');
        const data = await response.json();
        
        const select = document.getElementById('template-select');
        select.innerHTML = '<option value="">-- é€‰æ‹©æ¨¡æ¿ --</option>';
        
        data.templates.forEach(template => {
            const option = document.createElement('option');
            option.value = template.id;
            option.textContent = `${template.name} (${new Date(template.created_at).toLocaleDateString()})`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('åŠ è½½æ¨¡æ¿åˆ—è¡¨å¤±è´¥:', error);
    }
}

async function loadSelectedTemplate() {
    const templateId = document.getElementById('template-select').value;
    if (!templateId) return;
    
    if (!confirm('åº”ç”¨æ¨¡æ¿å°†è¦†ç›–å½“å‰æ‰€æœ‰é…ç½®ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
        document.getElementById('template-select').value = '';
        return;
    }
    
    try {
        const response = await fetch(`/api/templates/${templateId}/apply/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({task_id: currentTaskId})
        });
        
        const data = await response.json();
        if (data.success) {
            alert('æ¨¡æ¿åº”ç”¨æˆåŠŸï¼é…ç½®å·²æ›´æ–°ã€‚');
            // é‡æ–°åŠ è½½ä»»åŠ¡æ•°æ®
            if (currentTaskId) {
                loadExistingTask(currentTaskId);
            }
        } else {
            alert('åº”ç”¨æ¨¡æ¿å¤±è´¥: ' + data.error);
        }
    } catch (error) {
        alert('åº”ç”¨æ¨¡æ¿å¤±è´¥: ' + error);
    }
}

async function saveCurrentTemplate() {
    const templateName = document.getElementById('template-name-input').value.trim();
    if (!templateName) {
        alert('è¯·è¾“å…¥æ¨¡æ¿åç§°');
        return;
    }
    
    if (!currentTaskId) {
        alert('è¯·å…ˆåˆ›å»ºä»»åŠ¡');
        return;
    }
    
    try {
        const response = await fetch('/api/templates/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                name: templateName,
                task_id: currentTaskId
            })
        });
        
        const data = await response.json();
        if (data.success) {
            alert('æ¨¡æ¿ä¿å­˜æˆåŠŸï¼');
            document.getElementById('template-name-input').value = '';
            loadTemplatesList();
        } else {
            alert('ä¿å­˜æ¨¡æ¿å¤±è´¥: ' + data.error);
        }
    } catch (error) {
        alert('ä¿å­˜æ¨¡æ¿å¤±è´¥: ' + error);
    }
}

// æ–‡ä»¶é¢„è§ˆ
function updatePreviewFilesList() {
    const container = document.getElementById('preview-files-list');
    container.innerHTML = '';
    
    if (uploadedFiles.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted);">æš‚æ— å·²ä¸Šä¼ çš„æ–‡ä»¶</p>';
        return;
    }
    
    // æ”¯æŒé¢„è§ˆçš„æ–‡ä»¶æ ¼å¼
    const supportedFormats = ['.xlsx', '.xls', '.csv'];
    
    uploadedFiles.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'preview-file-item';
        fileItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 0.5rem;';
        
        // æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
        const fileName = file.name.toLowerCase();
        const isSupported = supportedFormats.some(ext => fileName.endsWith(ext));
        
        let buttonHTML = '';
        if (isSupported) {
            buttonHTML = `
                <button type="button" class="btn btn-sm btn-info" onclick="previewFileData(${index})">
                    <i class="fas fa-eye"></i> é¢„è§ˆæ•°æ®
                </button>
            `;
        } else {
            buttonHTML = `
                <span style="color: var(--text-muted); font-size: 0.85rem;">
                    <i class="fas fa-info-circle"></i> ä»…æ”¯æŒ Excel/CSV é¢„è§ˆ
                </span>
            `;
        }
        
        fileItem.innerHTML = `
            <div>
                <strong>${file.name}</strong>
                <small style="color: var(--text-muted); margin-left: 1rem;">${file.size} bytes</small>
            </div>
            ${buttonHTML}
        `;
        container.appendChild(fileItem);
    });
}

async function previewFileData(fileIndex) {
    const file = uploadedFiles[fileIndex];
    if (!file) return;
    
    try {
        showLoading('æ­£åœ¨ç”Ÿæˆé¢„è§ˆ...');
        
        const response = await fetch(`/api/files/${file.id}/preview/`, {
            method: 'GET'
        });
        
        hideLoading();
        
        const data = await response.json();
        if (data.success) {
            showPreviewModal(data.preview);
        } else {
            alert('é¢„è§ˆå¤±è´¥: ' + data.error);
        }
    } catch (error) {
        hideLoading();
        alert('é¢„è§ˆå¤±è´¥: ' + error);
    }
}

function showPreviewModal(preview) {
    // åˆ›å»ºæ¨¡æ€æ¡†
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 9999;';
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = 'background: white; padding: 2rem; border-radius: 8px; max-width: 90vw; max-height: 90vh; overflow: auto;';
    
    // ç»Ÿè®¡ä¿¡æ¯
    let statsHTML = `
        <h2 style="margin-bottom: 1rem;"><i class="fas fa-table"></i> æ•°æ®é¢„è§ˆ</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
            <div style="padding: 1rem; background: #f0f9ff; border-radius: 4px;">
                <div style="font-size: 0.9rem; color: #666;">æ€»è¡Œæ•°</div>
                <div style="font-size: 1.5rem; font-weight: bold; color: #0284c7;">${preview.total_rows}</div>
            </div>
            <div style="padding: 1rem; background: #f0fdf4; border-radius: 4px;">
                <div style="font-size: 0.9rem; color: #666;">æ€»åˆ—æ•°</div>
                <div style="font-size: 1.5rem; font-weight: bold; color: #16a34a;">${preview.total_columns}</div>
            </div>
            <div style="padding: 1rem; background: #fef3c7; border-radius: 4px;">
                <div style="font-size: 0.9rem; color: #666;">é¢„è§ˆè¡Œæ•°</div>
                <div style="font-size: 1.5rem; font-weight: bold; color: #ca8a04;">${preview.preview_rows}</div>
            </div>
        </div>
    `;
    
    // åˆ—ç±»å‹ç»Ÿè®¡
    if (preview.column_types) {
        statsHTML += '<h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">åˆ—ç±»å‹ç»Ÿè®¡</h3>';
        statsHTML += '<div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">';
        for (const [col, type] of Object.entries(preview.column_types)) {
            statsHTML += `<span style="padding: 0.25rem 0.75rem; background: #e0e7ff; color: #4338ca; border-radius: 4px; font-size: 0.85rem;">${col}: ${type}</span>`;
        }
        statsHTML += '</div>';
    }
    
    // ç©ºå€¼ç»Ÿè®¡
    if (preview.null_counts) {
        const hasNulls = Object.values(preview.null_counts).some(count => count > 0);
        if (hasNulls) {
            statsHTML += '<h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">ç©ºå€¼ç»Ÿè®¡</h3>';
            statsHTML += '<div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">';
            for (const [col, count] of Object.entries(preview.null_counts)) {
                if (count > 0) {
                    statsHTML += `<span style="padding: 0.25rem 0.75rem; background: #fee2e2; color: #dc2626; border-radius: 4px; font-size: 0.85rem;">${col}: ${count}ä¸ªç©ºå€¼</span>`;
                }
            }
            statsHTML += '</div>';
        }
    }
    
    // æ•°æ®è¡¨æ ¼
    statsHTML += '<h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">æ•°æ®é¢„è§ˆ (å‰100è¡Œ)</h3>';
    statsHTML += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">';
    statsHTML += '<thead><tr style="background: #f3f4f6;">';
    preview.columns.forEach(col => {
        statsHTML += `<th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: left;">${col}</th>`;
    });
    statsHTML += '</tr></thead><tbody>';
    
    preview.data.forEach((row, idx) => {
        statsHTML += `<tr style="${idx % 2 === 0 ? 'background: white;' : 'background: #f9fafb;'}">`;
        preview.columns.forEach(col => {
            const value = row[col] !== null && row[col] !== undefined ? row[col] : '';
            statsHTML += `<td style="padding: 0.5rem; border: 1px solid #e5e7eb;">${value}</td>`;
        });
        statsHTML += '</tr>';
    });
    
    statsHTML += '</tbody></table></div>';
    
    statsHTML += `
        <div style="margin-top: 1.5rem; text-align: right;">
            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                <i class="fas fa-times"></i> å…³é—­
            </button>
        </div>
    `;
    
    modalContent.innerHTML = statsHTML;
    modal.appendChild(modalContent);
    document.body.appendChild(modal);
}

// æ•°æ®æ¸…æ´—è§„åˆ™
function addCleaningRuleToList() {
    const ruleType = document.getElementById('cleaning-rule-type').value;
    const column = document.getElementById('cleaning-rule-column').value.trim();
    const paramsStr = document.getElementById('cleaning-rule-params').value.trim();
    
    let params = {};
    if (paramsStr) {
        try {
            params = JSON.parse(paramsStr);
        } catch (e) {
            alert('å‚æ•°æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„JSON');
            return;
        }
    }
    
    const rule = {
        rule_type: ruleType,
        column: column || null,
        params: params
    };
    
    cleaningRulesList.push(rule);
    renderCleaningRules();
    
    // æ¸…ç©ºè¾“å…¥
    document.getElementById('cleaning-rule-column').value = '';
    document.getElementById('cleaning-rule-params').value = '';
}

function renderCleaningRules() {
    const container = document.getElementById('cleaning-rules-container');
    container.innerHTML = '';
    
    if (cleaningRulesList.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted);">æš‚æ— æ¸…æ´—è§„åˆ™</p>';
        return;
    }
    
    const ruleTypeMap = {
        'remove_duplicates': 'å»é™¤é‡å¤è¡Œ',
        'fill_null': 'å¡«å……ç©ºå€¼',
        'trim_whitespace': 'å»é™¤ç©ºæ ¼',
        'standardize_case': 'æ ‡å‡†åŒ–å¤§å°å†™',
        'standardize_date': 'æ ‡å‡†åŒ–æ—¥æœŸ',
        'remove_special_chars': 'ç§»é™¤ç‰¹æ®Šå­—ç¬¦',
        'standardize_phone': 'æ ‡å‡†åŒ–ç”µè¯å·ç '
    };
    
    cleaningRulesList.forEach((rule, index) => {
        const ruleItem = document.createElement('div');
        ruleItem.style.cssText = 'padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;';
        
        ruleItem.innerHTML = `
            <div>
                <strong>${ruleTypeMap[rule.rule_type] || rule.rule_type}</strong>
                ${rule.column ? ` - åˆ—: ${rule.column}` : ' - å…¨éƒ¨åˆ—'}
                ${Object.keys(rule.params).length > 0 ? ` - å‚æ•°: ${JSON.stringify(rule.params)}` : ''}
            </div>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeCleaningRule(${index})">
                <i class="fas fa-trash"></i> åˆ é™¤
            </button>
        `;
        container.appendChild(ruleItem);
    });
}

function removeCleaningRule(index) {
    cleaningRulesList.splice(index, 1);
    renderCleaningRules();
}

// æ•°æ®éªŒè¯è§„åˆ™
function addValidationRuleToList() {
    const ruleType = document.getElementById('validation-rule-type').value;
    const column = document.getElementById('validation-rule-column').value.trim();
    const paramsStr = document.getElementById('validation-rule-params').value.trim();
    
    if (!column) {
        alert('è¯·è¾“å…¥éªŒè¯åˆ—å');
        return;
    }
    
    let params = {};
    if (paramsStr) {
        try {
            params = JSON.parse(paramsStr);
        } catch (e) {
            alert('å‚æ•°æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„JSON');
            return;
        }
    }
    
    const rule = {
        rule_type: ruleType,
        column: column,
        params: params
    };
    
    validationRulesList.push(rule);
    renderValidationRules();
    
    // æ¸…ç©ºè¾“å…¥
    document.getElementById('validation-rule-column').value = '';
    document.getElementById('validation-rule-params').value = '';
}

function renderValidationRules() {
    const container = document.getElementById('validation-rules-container');
    container.innerHTML = '';
    
    if (validationRulesList.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted);">æš‚æ— éªŒè¯è§„åˆ™</p>';
        return;
    }
    
    const ruleTypeMap = {
        'type_check': 'ç±»å‹æ£€æŸ¥',
        'range_check': 'èŒƒå›´éªŒè¯',
        'regex_match': 'æ­£åˆ™åŒ¹é…',
        'not_null': 'éç©ºæ£€æŸ¥',
        'unique': 'å”¯ä¸€æ€§æ£€æŸ¥',
        'length_check': 'é•¿åº¦æ£€æŸ¥',
        'enum_check': 'æšä¸¾å€¼æ£€æŸ¥'
    };
    
    validationRulesList.forEach((rule, index) => {
        const ruleItem = document.createElement('div');
        ruleItem.style.cssText = 'padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;';
        
        ruleItem.innerHTML = `
            <div>
                <strong>${ruleTypeMap[rule.rule_type] || rule.rule_type}</strong>
                - åˆ—: ${rule.column}
                ${Object.keys(rule.params).length > 0 ? ` - å‚æ•°: ${JSON.stringify(rule.params)}` : ''}
            </div>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeValidationRule(${index})">
                <i class="fas fa-trash"></i> åˆ é™¤
            </button>
        `;
        container.appendChild(ruleItem);
    });
}

function removeValidationRule(index) {
    validationRulesList.splice(index, 1);
    renderValidationRules();
}

async function runDataValidation() {
    if (!currentTaskId) {
        alert('è¯·å…ˆåˆ›å»ºä»»åŠ¡');
        return;
    }
    
    if (validationRulesList.length === 0) {
        alert('è¯·å…ˆæ·»åŠ éªŒè¯è§„åˆ™');
        return;
    }
    
    try {
        showLoading('æ­£åœ¨éªŒè¯æ•°æ®...');
        
        // å…ˆæ·»åŠ éªŒè¯è§„åˆ™
        await fetch('/api/validation-rules/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                task_id: currentTaskId,
                rules: validationRulesList
            })
        });
        
        // è¿è¡ŒéªŒè¯
        const response = await fetch(`/api/tasks/${currentTaskId}/validate/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        hideLoading();
        
        const data = await response.json();
        if (data.success) {
            displayValidationResults(data.results);
        } else {
            alert('éªŒè¯å¤±è´¥: ' + data.error);
        }
    } catch (error) {
        hideLoading();
        alert('éªŒè¯å¤±è´¥: ' + error);
    }
}

function displayValidationResults(results) {
    const container = document.getElementById('validation-results');
    
    if (results.length === 0) {
        container.innerHTML = '<div style="padding: 1rem; background: #d1fae5; color: #065f46; border-radius: 4px;"><i class="fas fa-check-circle"></i> æ•°æ®éªŒè¯é€šè¿‡ï¼Œæœªå‘ç°é”™è¯¯ï¼</div>';
        return;
    }
    
    let html = `<div style="padding: 1rem; background: #fee2e2; color: #991b1b; border-radius: 4px; margin-bottom: 1rem;">
        <strong><i class="fas fa-exclamation-triangle"></i> å‘ç° ${results.length} ä¸ªéªŒè¯é”™è¯¯</strong>
    </div>`;
    
    html += '<div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 1rem;">';
    results.forEach((result, index) => {
        html += `
            <div style="padding: 0.75rem; border-left: 3px solid #dc2626; background: #fef2f2; margin-bottom: 0.5rem; border-radius: 4px;">
                <div><strong>é”™è¯¯ ${index + 1}:</strong> ${result.error_message}</div>
                <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
                    è¡Œ: ${result.row_number}, åˆ—: ${result.column}, è§„åˆ™: ${result.rule_type}
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

// ç”Ÿæˆç»Ÿè®¡å›¾è¡¨
async function generateChartsForTask() {
    if (!currentTaskId) {
        alert('è¯·å…ˆåˆ›å»ºå¹¶å¤„ç†ä»»åŠ¡');
        return;
    }

    try {
        showLoading('æ­£åœ¨ç”Ÿæˆç»Ÿè®¡å›¾è¡¨...');

        const response = await fetch(`/api/tasks/${currentTaskId}/charts/`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            },
            credentials: 'same-origin'
        });

        const contentType = response.headers.get('content-type') || '';
        let payload;

        if (contentType.includes('application/json')) {
            payload = await response.json();
        } else {
            const text = await response.text();
            throw new Error(text || `æœåŠ¡è¿”å›äº†é JSON å“åº” (HTTP ${response.status})`);
        }

        if (!response.ok) {
            const errorMsg = payload?.error || `ç”Ÿæˆå›¾è¡¨å¤±è´¥ (HTTP ${response.status})`;
            throw new Error(errorMsg);
        }

        if (payload.success) {
            if (payload.warning) {
                showToast(payload.warning, 'warning');
            }
            showChartsModal(payload.charts, payload.warning, payload.statistics);
        } else {
            throw new Error(payload.error || 'æœªçŸ¥é”™è¯¯');
        }
    } catch (error) {
        showToast(`ç”Ÿæˆå›¾è¡¨å¤±è´¥: ${error.message || error}`, 'error');
    } finally {
        hideLoading();
    }
}

function showChartsModal(charts, warning = null, statistics = null) {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 9999;';
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = 'background: white; padding: 2rem; border-radius: 8px; max-width: 90vw; max-height: 90vh; overflow: auto;';
    
    let html = '<h2 style="margin-bottom: 1.5rem;"><i class="fas fa-chart-bar"></i> ç»Ÿè®¡å›¾è¡¨</h2>';
    
    // æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
    if (warning) {
        html += `
            <div style="padding: 1rem; background: #fef3c7; color: #92400e; border-radius: 4px; margin-bottom: 1.5rem; border-left: 4px solid #f59e0b;">
                <i class="fas fa-exclamation-triangle"></i> ${warning}
            </div>
        `;
    }
    
    const chartSections = [];
    if (charts?.data_distribution) chartSections.push(charts.data_distribution);
    if (charts?.column_types) chartSections.push(charts.column_types);
    if (charts?.null_analysis) chartSections.push(charts.null_analysis);
    if (charts?.numeric_stats) chartSections.push(charts.numeric_stats);
    if (charts?.text_frequency) chartSections.push(charts.text_frequency);

    if (chartSections.length === 0) {
        html += '<p style="color: var(--text-muted);">æš‚æ— å¯ç”¨çš„ç»Ÿè®¡å›¾è¡¨ã€‚è¯·ç¡®ä¿å·²ä¸Šä¼ æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼ˆExcel æˆ– CSVï¼‰ã€‚</p>';
    } else {
        html += '<div style="display: grid; gap: 2rem;">';
        chartSections.forEach(chart => {
            html += `
                <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem;">
                    <h3 style="margin-bottom: 1rem;">${chart.title}</h3>
                    <div>${renderChartHTML(chart)}</div>
                </div>
            `;
        });
        html += '</div>';
    }
    
    if (statistics && Object.keys(statistics).length > 0) {
        html += `
            <div style="margin-top: 2rem;">
                <h3 style="margin-bottom: 1rem;"><i class="fas fa-chart-line"></i> æ•°å€¼ç»Ÿè®¡æ‘˜è¦</h3>
                <div style="display: grid; gap: 0.75rem;">
                    ${Object.entries(statistics).map(([column, stats]) => `
                        <div style="padding: 0.75rem; background: #f3f4f6; border-radius: 6px;">
                            <strong>${column}</strong>
                            <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 0.5rem;">
                                ${stats.min !== undefined ? `<span>æœ€å°å€¼: ${stats.min.toFixed(2)}</span>` : ''}
                                ${stats.max !== undefined ? `<span>æœ€å¤§å€¼: ${stats.max.toFixed(2)}</span>` : ''}
                                ${stats.mean !== undefined ? `<span>å¹³å‡å€¼: ${stats.mean.toFixed(2)}</span>` : ''}
                                ${stats.median !== undefined ? `<span>ä¸­ä½æ•°: ${stats.median.toFixed(2)}</span>` : ''}
                                ${stats.count !== undefined ? `<span>æ•°æ®é‡: ${stats.count}</span>` : ''}
                                ${stats.unique_count !== undefined ? `<span>å”¯ä¸€å€¼: ${stats.unique_count}</span>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    html += `
        <div style="margin-top: 1.5rem; text-align: right;">
            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                <i class="fas fa-times"></i> å…³é—­
            </button>
        </div>
    `;
    
    modalContent.innerHTML = html;
    modal.appendChild(modalContent);
    document.body.appendChild(modal);
}

function renderChartHTML(chart) {
    if (chart.type === 'bar') {
        return renderBarChart(chart.data);
    } else if (chart.type === 'pie') {
        return renderPieChart(chart.data);
    } else if (chart.type === 'line') {
        return renderLineChart(chart.data);
    } else if (chart.type === 'boxplot') {
        return renderBoxPlot(chart.data);
    } else if (chart.type === 'wordcloud') {
        return renderWordCloud(chart.data);
    }
    return '<p>ä¸æ”¯æŒçš„å›¾è¡¨ç±»å‹</p>';
}

function renderBarChart(data) {
    const categories = Array.isArray(data?.categories) ? data.categories : Object.keys(data || {});
    const values = Array.isArray(data?.values) ? data.values : Object.values(data || {});
    const maxValue = values.length > 0 ? Math.max(...values, 0) : 0;
    let html = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
    
    categories.forEach((label, index) => {
        const value = Number(values[index] ?? 0);
        const denominator = maxValue === 0 ? 1 : maxValue;
        const percentage = ((value / denominator) * 100).toFixed(1);
        html += `
            <div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <span>${label}</span>
                    <span><strong>${value}</strong></span>
                </div>
                <div style="background: #e5e7eb; border-radius: 4px; height: 24px; overflow: hidden;">
                    <div style="background: linear-gradient(to right, #3b82f6, #2563eb); height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    return html;
}

function renderPieChart(data) {
    const labels = Array.isArray(data?.labels) ? data.labels : Object.keys(data || {});
    const values = Array.isArray(data?.values) ? data.values : Object.values(data || {});
    const total = values.reduce((a, b) => a + Number(b || 0), 0);
    let html = '<div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: center;">';
    
    // ç®€å•çš„é¢œè‰²åˆ—è¡¨
    const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
    
    html += '<div style="flex: 1; min-width: 200px;">';
    const segments = [];
    
    labels.forEach((label, index) => {
        const value = Number(values[index] ?? 0);
        const percent = total === 0 ? 0 : (value / total * 100);
        segments.push({
            label,
            value,
            percentage: percent.toFixed(1),
            color: colors[index % colors.length]
        });
    });
    
    // å›¾ä¾‹
    html += '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
    segments.forEach(seg => {
        html += `
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="width: 16px; height: 16px; background: ${seg.color}; border-radius: 2px;"></div>
                <span>${seg.label}: ${seg.value} (${seg.percentage}%)</span>
            </div>
        `;
    });
    html += '</div></div>';
    
    html += '</div>';
    return html;
}

function renderLineChart(data) {
    // ç®€åŒ–çš„æŠ˜çº¿å›¾æ˜¾ç¤ºï¼ˆä¸æŸ±çŠ¶å›¾å…±äº«åŒä¸€æ•°æ®ç»“æ„ï¼‰
    return renderBarChart(data);
}

function renderBoxPlot(data) {
    if (!data || data.length === 0) {
        return '<p style="color: var(--text-muted);">æ²¡æœ‰å¯ç”¨çš„æ•°å€¼ç»Ÿè®¡æ•°æ®ã€‚</p>';
    }

    let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; min-width: 600px;">';
    html += '<thead><tr style="background: #f9fafb;">'
        + '<th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border-color);">åˆ—å</th>'
        + '<th style="padding: 0.5rem; text-align: right; border-bottom: 1px solid var(--border-color);">æœ€å°å€¼</th>'
        + '<th style="padding: 0.5rem; text-align: right; border-bottom: 1px solid var(--border-color);">ç¬¬ä¸€å››åˆ†ä½</th>'
        + '<th style="padding: 0.5rem; text-align: right; border-bottom: 1px solid var(--border-color);">ä¸­ä½æ•°</th>'
        + '<th style="padding: 0.5rem; text-align: right; border-bottom: 1px solid var(--border-color);">ç¬¬ä¸‰å››åˆ†ä½</th>'
        + '<th style="padding: 0.5rem; text-align: right; border-bottom: 1px solid var(--border-color);">æœ€å¤§å€¼</th>'
        + '<th style="padding: 0.5rem; text-align: right; border-bottom: 1px solid var(--border-color);">æ ·æœ¬é‡</th>'
        + '</tr></thead><tbody>';

    data.forEach(row => {
        html += '<tr>'
            + `<td style="padding: 0.5rem; border-bottom: 1px solid var(--border-color);">${row.column}</td>`
            + `<td style="padding: 0.5rem; text-align: right; border-bottom: 1px solid var(--border-color);">${row.min.toFixed(2)}</td>`
            + `<td style="padding: 0.5rem; text-align: right; border-bottom: 1px solid var(--border-color);">${row.q1.toFixed(2)}</td>`
            + `<td style="padding: 0.5rem; text-align: right; border-bottom: 1px solid var(--border-color);">${row.median.toFixed(2)}</td>`
            + `<td style="padding: 0.5rem; text-align: right; border-bottom: 1px solid var(--border-color);">${row.q3.toFixed(2)}</td>`
            + `<td style="padding: 0.5rem; text-align: right; border-bottom: 1px solid var(--border-color);">${row.max.toFixed(2)}</td>`
            + `<td style="padding: 0.5rem; text-align: right; border-bottom: 1px solid var(--border-color);">${row.count}</td>`
            + '</tr>';
    });

    html += '</tbody></table></div>';
    return html;
}

function renderWordCloud(data) {
    if (!data || Object.keys(data).length === 0) {
        return '<p style="color: var(--text-muted);">æ²¡æœ‰å¯ç”¨çš„æ–‡æœ¬é¢‘ç‡æ•°æ®ã€‚</p>';
    }

    let html = '<div style="display: grid; gap: 1rem;">';
    Object.entries(data).forEach(([column, stats]) => {
        const items = stats.most_common || [];
        html += '<div style="padding: 1rem; background: #f9fafb; border-radius: 6px;">'
            + `<h4 style="margin-bottom: 0.75rem; font-size: 1rem;">${column}</h4>`
            + `<p style="margin-bottom: 0.75rem; color: var(--text-muted);">æ€»è®¡: ${stats.total_count} | å”¯ä¸€å€¼: ${stats.unique_count}</p>`
            + '<div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">'
            + items.map(([value, count]) => `
                <span style="display: inline-flex; align-items: center; gap: 0.35rem; background: #e0f2fe; color: #0369a1; padding: 0.35rem 0.6rem; border-radius: 999px; font-size: 0.9rem;">
                    <span>${value}</span>
                    <span style="background: rgba(255,255,255,0.7); color: #0f172a; padding: 0 0.4rem; border-radius: 999px; font-size: 0.8rem;">${count}</span>
                </span>
            `).join('')
            + '</div>'
            + '</div>';
    });
    html += '</div>';
    return html;
}

function showLoading(message = 'åŠ è½½ä¸­...') {
    const loading = document.createElement('div');
    loading.id = 'loading-overlay';
    loading.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
    loading.innerHTML = `<div style="background: white; padding: 2rem; border-radius: 8px; text-align: center;"><div style="font-size: 2rem; margin-bottom: 1rem;">â³</div><div>${message}</div></div>`;
    document.body.appendChild(loading);
}

function hideLoading() {
    const loading = document.getElementById('loading-overlay');
    if (loading) {
        loading.remove();
    }
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: white;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        z-index: 10001;
        animation: slideIn 0.3s ease;
        max-width: 400px;
    `;
    
    const colors = {
        success: '#10b981',
        error: '#ef4444',
        warning: '#f59e0b',
        info: '#3b82f6'
    };
    
    const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
    };
    
    toast.innerHTML = `
        <i class="fas ${icons[type]}" style="color: ${colors[type]}; font-size: 1.5rem;"></i>
        <span style="color: #333;">${message}</span>
    `;
    
    document.body.appendChild(toast);
    
    // è‡ªåŠ¨éšè—
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

// æ·»åŠ åŠ¨ç”»æ ·å¼
if (!document.getElementById('toast-animations')) {
    const style = document.createElement('style');
    style.id = 'toast-animations';
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
}

</script>
{% endblock %}
