{% extends 'base.html' %}
{% load static %}

{% block title %}å›¾è¡¨å®éªŒå®¤ - Excel åˆå¹¶å·¥å…·{% endblock %}

{% block extra_css %}
<style>
.chart-lab-container {
    max-width: 1400px;
    margin: 0 auto;
}

.chart-section {
    background: var(--card-bg);
    border-radius: 1rem;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
}

.chart-section:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
}

.section-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--border-color);
}

.section-header h2 {
    font-size: 1.5rem;
    margin: 0;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.section-header .section-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
    border-radius: 12px;
    color: white;
    font-size: 1.5rem;
}

.panel-hint {
    color: var(--text-muted);
    font-size: 0.95rem;
    margin-bottom: 1.5rem;
}

.form-row {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.form-row .form-group {
    flex: 1;
}

.form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-color);
}

.form-group label i {
    color: var(--primary-color);
    margin-right: 0.25rem;
}

.table-scroll {
    max-height: 400px;
    overflow: auto;
    margin-top: 1.5rem;
    border-radius: 0.75rem;
    border: 1px solid var(--border-color);
    background: var(--bg-color);
    box-shadow: var(--shadow-sm);
}

.table-scroll table {
    width: 100%;
    border-collapse: collapse;
}

.table-scroll thead {
    position: sticky;
    top: 0;
    background: var(--primary-color);
    color: white;
    z-index: 10;
}

.table-scroll th {
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.9rem;
}

.table-scroll td {
    padding: 0.75rem;
    border-bottom: 1px solid var(--border-color);
    font-size: 0.9rem;
}

.table-scroll tbody tr:hover {
    background: rgba(99, 102, 241, 0.05);
}

.config-section {
    background: var(--bg-color);
    padding: 1.5rem;
    border-radius: 0.75rem;
    margin-top: 1.5rem;
    border: 1px solid var(--border-color);
}

.config-section h4 {
    margin-bottom: 1rem;
    font-size: 1.1rem;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.filter-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
}

.filter-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 0.85rem;
    border-radius: 999px;
    background: var(--primary-color);
    color: white;
    font-size: 0.85rem;
    box-shadow: var(--shadow-sm);
}

.filter-badge button {
    border: none;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    cursor: pointer;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.filter-badge button:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.chart-display {
    text-align: center;
    padding: 2rem;
    background: var(--bg-color);
    border-radius: 1rem;
    border: 1px solid var(--border-color);
    min-height: 400px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.chart-display img {
    max-width: 100%;
    height: auto;
    border-radius: 0.75rem;
    box-shadow: var(--shadow-lg);
}

.stat-grid {
    display: grid;
    gap: 1rem;
    margin-top: 1.5rem;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
}

.stat-card {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    padding: 1rem;
    box-shadow: var(--shadow-sm);
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.stat-card h4 {
    margin-bottom: 0.75rem;
    font-size: 1rem;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.badge-group {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
}

.badge {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.35rem 0.75rem;
    border-radius: 999px;
    background: rgba(99, 102, 241, 0.1);
    color: var(--primary-dark);
    font-size: 0.85rem;
    font-weight: 500;
}

.warning-banner {
    margin-top: 1.5rem;
    padding: 1rem 1.25rem;
    border-radius: 0.75rem;
    background: rgba(249, 115, 22, 0.1);
    border-left: 4px solid var(--warning-color);
    color: var(--text-color);
    display: flex;
    align-items: start;
    gap: 0.75rem;
}

.warning-banner i {
    color: var(--warning-color);
    font-size: 1.25rem;
    margin-top: 0.1rem;
}

.summary-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    padding: 1.5rem;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
    border-radius: 0.75rem;
    margin-top: 1.5rem;
    box-shadow: var(--shadow-md);
}

.summary-item {
    flex: 1 1 180px;
    text-align: center;
    color: white;
}

.summary-item span {
    display: block;
    font-size: 0.85rem;
    opacity: 0.9;
    margin-bottom: 0.25rem;
}

.summary-item strong {
    display: block;
    font-size: 1.5rem;
    font-weight: 700;
}

.wizard-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-color);
}

@media (max-width: 768px) {
    .form-row {
        flex-direction: column;
    }
    
    .stat-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-flask"></i> å›¾è¡¨å®éªŒå®¤</h1>
    <p>å¿«é€Ÿæ¢ç´¢æ•°æ®ã€ç”Ÿæˆä¸“ä¸šç»Ÿè®¡å›¾è¡¨ï¼Œæ— éœ€åˆ›å»ºåˆå¹¶ä»»åŠ¡</p>
    <div class="badge-group" style="margin-top: 0.75rem;">
        <span class="badge"><i class="fas fa-chart-line"></i> pandas Â· matplotlib</span>
        <span class="badge"><i class="fas fa-bolt"></i> å³æ—¶é¢„è§ˆ</span>
        <span class="badge"><i class="fas fa-filter"></i> æ¡ä»¶è¿‡æ»¤</span>
    </div>
</div>

<div class="chart-lab-container">
    <!-- æ­¥éª¤ 1: æ•°æ®ä¸Šä¼ ä¸é¢„è§ˆ -->
    <section class="chart-section">
        <div class="section-header">
            <div class="section-icon">
                <i class="fas fa-upload"></i>
            </div>
            <div>
                <h2>æ­¥éª¤ 1: æ•°æ®ä¸Šä¼ ä¸é¢„è§ˆ</h2>
                <p class="panel-hint" style="margin: 0;">ä¸Šä¼  Excel/CSV/JSON æ–‡ä»¶ï¼Œè‡ªåŠ¨è¯†åˆ«åˆ—ç»“æ„å’Œæ•°æ®ç±»å‹</p>
            </div>
        </div>

        <form id="inspectForm">
            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label for="dataFile"><i class="fas fa-file-excel"></i> é€‰æ‹©æ•°æ®æ–‡ä»¶</label>
                    <input type="file" id="dataFile" name="file" class="form-control" accept=".xlsx,.xls,.csv,.json" required>
                    <small class="form-hint"><i class="fas fa-info-circle"></i> æ”¯æŒ XLSX, XLS, CSV, JSON æ ¼å¼ï¼Œé¢„è§ˆæœ€å¤š 50,000 è¡Œ</small>
                </div>
                <div class="form-group">
                    <label for="sheetName"><i class="fas fa-table"></i> å·¥ä½œè¡¨åç§° (å¯é€‰)</label>
                    <input type="text" id="sheetName" name="sheet_name" class="form-control" placeholder="é»˜è®¤ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨">
                </div>
                <div class="form-group">
                    <label for="previewRows"><i class="fas fa-list-ol"></i> é¢„è§ˆè¡Œæ•°</label>
                    <input type="number" id="previewRows" name="preview_rows" class="form-control" value="30" min="5" max="200">
                </div>
            </div>

            <div class="wizard-actions">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-eye"></i> ç”Ÿæˆæ•°æ®é¢„è§ˆ
                </button>
                <button type="button" class="btn btn-secondary" id="resetInspectBtn">
                    <i class="fas fa-undo"></i> é‡ç½®
                </button>
            </div>
        </form>

        <div id="inspectSummary" class="summary-bar" style="display:none;"></div>
        <div id="previewContainer" class="table-scroll" style="display:none;"></div>
        <div id="statisticsContainer" class="stat-grid" style="display:none;"></div>
    </section>

    <!-- æ­¥éª¤ 2: å›¾è¡¨é…ç½® -->
    <section class="chart-section">
        <div class="section-header">
            <div class="section-icon">
                <i class="fas fa-sliders-h"></i>
            </div>
            <div>
                <h2>æ­¥éª¤ 2: å›¾è¡¨é…ç½®</h2>
                <p class="panel-hint" style="margin: 0;">é€‰æ‹©ç»´åº¦ã€æŒ‡æ ‡ä¸æ ·å¼ï¼Œæ”¯æŒåˆ†ç»„èšåˆå’Œæ¡ä»¶è¿‡æ»¤</p>
            </div>
        </div>
        <div class="config-section">
            <h4><i class="fas fa-chart-bar"></i> åŸºæœ¬è®¾ç½®</h4>
            <div class="form-row">
                <div class="form-group">
                    <label for="chartType"><i class="fas fa-shapes"></i> å›¾è¡¨ç±»å‹</label>
                    <select id="chartType" class="form-control">
                        <option value="bar">æŸ±çŠ¶å›¾</option>
                        <option value="line">æŠ˜çº¿å›¾</option>
                        <option value="scatter">æ•£ç‚¹å›¾</option>
                        <option value="hist">ç›´æ–¹å›¾</option>
                        <option value="box">ç®±çº¿å›¾</option>
                        <option value="pie">é¥¼å›¾</option>
                        <option value="area">é¢ç§¯å›¾</option>
                        <option value="barh">æ¡å½¢å›¾</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="xAxis"><i class="fas fa-arrows-alt-h"></i> X è½´å­—æ®µ</label>
                    <select id="xAxis" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label for="yAxis"><i class="fas fa-arrows-alt-v"></i> Y è½´å­—æ®µ (å¯å¤šé€‰)</label>
                    <select id="yAxis" class="form-control" multiple style="height: 38px;"></select>
                    <small class="form-hint"><i class="fas fa-info-circle"></i> æŒ‰ä½ Ctrl/Cmd å¤šé€‰</small>
                </div>
            </div>
        </div>

        <div class="config-section">
            <h4><i class="fas fa-layer-group"></i> æ•°æ®èšåˆ (å¯é€‰)</h4>
            <div class="info-box" style="background: #e7f3ff; border-left: 4px solid #2196F3; padding: 12px; margin-bottom: 16px; border-radius: 4px;">
                <i class="fas fa-info-circle" style="color: #2196F3; margin-right: 8px;"></i>
                <strong>ä½¿ç”¨æç¤º:</strong> å½“éœ€è¦å¯¹æ•°æ®è¿›è¡Œåˆ†ç»„ç»Ÿè®¡æ—¶ä½¿ç”¨æœ¬åŠŸèƒ½ã€‚ä¾‹å¦‚:
                <ul style="margin: 8px 0 0 24px; line-height: 1.8;">
                    <li>æŒ‰<strong>åŸå¸‚</strong>åˆ†ç»„,å¯¹<strong>é”€å”®é¢</strong>æ±‚å’Œ â†’ æŸ¥çœ‹å„åŸå¸‚æ€»é”€å”®é¢</li>
                    <li>æŒ‰<strong>æ—¥æœŸ</strong>åˆ†ç»„,å¯¹<strong>è®¿é—®é‡</strong>å¹³å‡ â†’ æŸ¥çœ‹æ¯æ—¥å¹³å‡è®¿é—®é‡</li>
                    <li>æŒ‰<strong>ç±»åˆ«+åœ°åŒº</strong>åˆ†ç»„,å¯¹<strong>æ•°é‡</strong>è®¡æ•° â†’ ç»Ÿè®¡å„ç±»åˆ«åœ¨å„åœ°åŒºçš„æ•°é‡</li>
                </ul>
                <small style="color: #555; display: block; margin-top: 8px;">ğŸ’¡ <em>ä¸é€‰æ‹©åˆ†ç»„å­—æ®µåˆ™ç›´æ¥å¯¹åŸå§‹æ•°æ®ç»˜å›¾</em></small>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="groupBy"><i class="fas fa-object-group"></i> åˆ†ç»„å­—æ®µ (å¯å¤šé€‰)</label>
                    <select id="groupBy" class="form-control" multiple style="height: 38px;"></select>
                    <small class="form-hint"><i class="fas fa-info-circle"></i> æŒ‰ä½ Ctrl/Cmd å¤šé€‰å¤šä¸ªåˆ†ç»„ç»´åº¦</small>
                </div>
                <div class="form-group">
                    <label for="aggregateFunc"><i class="fas fa-calculator"></i> èšåˆæ–¹å¼</label>
                    <select id="aggregateFunc" class="form-control">
                        <option value="sum">æ±‚å’Œ (sum)</option>
                        <option value="mean">å¹³å‡å€¼ (mean)</option>
                        <option value="count">è®¡æ•° (count)</option>
                        <option value="max">æœ€å¤§å€¼ (max)</option>
                        <option value="min">æœ€å°å€¼ (min)</option>
                        <option value="median">ä¸­ä½æ•° (median)</option>
                    </select>
                    <small class="form-hint"><i class="fas fa-info-circle"></i> é€‰æ‹©å¯¹åˆ†ç»„åçš„æ•°å€¼å­—æ®µè¿›è¡Œä½•ç§è®¡ç®—</small>
                </div>
            </div>
        </div>

        <div class="config-section">
            <h4><i class="fas fa-paint-brush"></i> æ ·å¼è®¾ç½®</h4>
            <div class="form-row">
                <div class="form-group">
                    <label for="chartTitle"><i class="fas fa-heading"></i> å›¾è¡¨æ ‡é¢˜</label>
                    <input type="text" id="chartTitle" class="form-control" placeholder="è‡ªå®šä¹‰æ ‡é¢˜ (å¯é€‰)">
                </div>
                <div class="form-group">
                    <label for="xLabel"><i class="fas fa-text-width"></i> X è½´åç§°</label>
                    <input type="text" id="xLabel" class="form-control" placeholder="é»˜è®¤ä½¿ç”¨å­—æ®µå">
                </div>
                <div class="form-group">
                    <label for="yLabel"><i class="fas fa-text-height"></i> Y è½´åç§°</label>
                    <input type="text" id="yLabel" class="form-control" placeholder="é»˜è®¤ä½¿ç”¨å­—æ®µå">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="chartWidth"><i class="fas fa-ruler-horizontal"></i> å®½åº¦ (è‹±å¯¸)</label>
                    <input type="number" id="chartWidth" class="form-control" value="10" min="4" max="20" step="0.5">
                </div>
                <div class="form-group">
                    <label for="chartHeight"><i class="fas fa-ruler-vertical"></i> é«˜åº¦ (è‹±å¯¸)</label>
                    <input type="number" id="chartHeight" class="form-control" value="6" min="3" max="16" step="0.5">
                </div>
                <div class="form-group">
                    <label for="xRotation"><i class="fas fa-sync-alt"></i> X è½´åˆ»åº¦è§’åº¦</label>
                    <input type="number" id="xRotation" class="form-control" value="0" min="-90" max="90">
                </div>
                <div class="form-group">
                    <label for="bins"><i class="fas fa-bars"></i> ç›´æ–¹å›¾åŒºé—´æ•°</label>
                    <input type="number" id="bins" class="form-control" value="20" min="5" max="100">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="autopct"><i class="fas fa-percentage"></i> é¥¼å›¾ç™¾åˆ†æ¯”æ ¼å¼</label>
                    <input type="text" id="autopct" class="form-control" value="%1.1f%%">
                </div>
                <div class="form-group" style="display: flex; align-items: center; gap: 1.5rem; padding-top: 2rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                        <input type="checkbox" id="showGrid" checked>
                        <span>æ˜¾ç¤ºç½‘æ ¼</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                        <input type="checkbox" id="showLegend" checked>
                        <span>æ˜¾ç¤ºå›¾ä¾‹</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="config-section">
            <h4><i class="fas fa-filter"></i> æ•°æ®è¿‡æ»¤æ¡ä»¶ (å¯é€‰)</h4>
            <div class="form-row">
                <div class="form-group">
                    <label for="filterColumn"><i class="fas fa-columns"></i> å­—æ®µ</label>
                    <select id="filterColumn" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label for="filterOperator"><i class="fas fa-equals"></i> æ¡ä»¶</label>
                    <select id="filterOperator" class="form-control">
                        <option value="==">ç­‰äº</option>
                        <option value="!=">ä¸ç­‰äº</option>
                        <option value=">">å¤§äº</option>
                        <option value=">=">å¤§äºç­‰äº</option>
                        <option value="<">å°äº</option>
                        <option value="<=">å°äºç­‰äº</option>
                        <option value="contains">åŒ…å«</option>
                        <option value="not_contains">ä¸åŒ…å«</option>
                        <option value="in">åŒ…å«ä»»æ„</option>
                        <option value="not_in">æ’é™¤</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filterValue"><i class="fas fa-keyboard"></i> å€¼ / å…³é”®å­—</label>
                    <input type="text" id="filterValue" class="form-control" placeholder="å¤šä¸ªå€¼ç”¨é€—å·åˆ†éš”">
                </div>
                <div class="form-group" style="align-self: flex-end;">
                    <button type="button" class="btn btn-secondary" id="addFilterBtn">
                        <i class="fas fa-plus"></i> æ·»åŠ æ¡ä»¶
                    </button>
                </div>
            </div>
            <div id="filterList" class="filter-badges"></div>
        </div>

        <div class="wizard-actions">
            <button type="button" class="btn btn-primary btn-lg" id="generateChartBtn" disabled>
                <i class="fas fa-chart-line"></i> ç”Ÿæˆå›¾è¡¨
            </button>
        </div>

        <div id="chartWarnings" class="warning-banner" style="display:none;"></div>
    </section>

    <!-- æ­¥éª¤ 3: å›¾è¡¨ç»“æœ -->
    <section class="chart-section">
        <div class="section-header">
            <div class="section-icon">
                <i class="fas fa-chart-area"></i>
            </div>
            <div>
                <h2>æ­¥éª¤ 3: å›¾è¡¨ç»“æœ</h2>
                <p class="panel-hint" style="margin: 0;">ç”Ÿæˆçš„å›¾è¡¨å’Œç»Ÿè®¡ä¿¡æ¯å°†åœ¨æ­¤å±•ç¤º</p>
            </div>
        </div>

        <div id="chartOutput" class="chart-display">
            <div style="text-align: center; color: var(--text-muted);">
                <i class="fas fa-chart-pie" style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                <p>å®Œæˆä¸Šè¿°é…ç½®åï¼Œç‚¹å‡»"ç”Ÿæˆå›¾è¡¨"æŒ‰é’®ï¼Œå›¾è¡¨å°†åœ¨æ­¤å¤„å±•ç¤º</p>
            </div>
        </div>

        <div id="chartStats" class="stat-grid" style="display:none;"></div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
    window.chartLabConfig = {
        inspectUrl: "{% url 'api_custom_chart_inspect' %}",
        generateUrl: "{% url 'api_generate_custom_chart' %}"
    };
</script>
<script src="{% static 'js/chart_lab.js' %}"></script>
{% endblock %}
