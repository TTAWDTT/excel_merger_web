{% extends 'base.html' %}

{% block title %}{{ task.name }} - ä»»åŠ¡è¯¦æƒ…{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ task.name }}</h1>
    <div class="header-actions">
        {% if task.result_file %}
        <a href="/api/tasks/{{ task.id }}/download/" class="btn btn-success">ä¸‹è½½ç»“æœ</a>
        {% endif %}
        <button class="btn btn-danger" onclick="deleteTask({{ task.id }})">åˆ é™¤ä»»åŠ¡</button>
    </div>
</div>

<div class="detail-grid">
    <div class="detail-card">
        <h3>åŸºæœ¬ä¿¡æ¯</h3>
        <div class="detail-item">
            <span class="label">çŠ¶æ€:</span>
            <span class="status-badge status-{{ task.status }}">{{ task.get_status_display }}</span>
        </div>
        <div class="detail-item">
            <span class="label">è¾“å‡ºæ ¼å¼:</span>
            <span>{{ task.output_format|upper }}</span>
        </div>
        <div class="detail-item">
            <span class="label">åˆ—è¿‡æ»¤:</span>
            <span>
                {% if task.filter_mode == 'none' %}
                    ä¸è¿‡æ»¤
                {% elif task.filter_mode == 'keep' %}
                    åªä¿ç•™æŒ‡å®šåˆ— ({{ task.filter_columns|length }} åˆ—)
                {% elif task.filter_mode == 'remove' %}
                    åˆ é™¤æŒ‡å®šåˆ— ({{ task.filter_columns|length }} åˆ—)
                {% endif %}
            </span>
        </div>
        <div class="detail-item">
            <span class="label">åˆ›å»ºæ—¶é—´:</span>
            <span>{{ task.created_at|date:"Y-m-d H:i:s" }}</span>
        </div>
        <div class="detail-item">
            <span class="label">æ›´æ–°æ—¶é—´:</span>
            <span>{{ task.updated_at|date:"Y-m-d H:i:s" }}</span>
        </div>
        {% if task.error_message %}
        <div class="detail-item error">
            <span class="label">é”™è¯¯ä¿¡æ¯:</span>
            <span>{{ task.error_message }}</span>
        </div>
        {% endif %}
    </div>

    <div class="detail-card">
        <h3>ä¸Šä¼ æ–‡ä»¶ ({{ task.files.count }})</h3>
        <ul class="file-list">
            {% for file in task.files.all %}
            <li>
                <span class="file-icon">ğŸ“„</span>
                {{ file.original_filename }}
            </li>
            {% empty %}
            <li class="empty">æœªä¸Šä¼ æ–‡ä»¶</li>
            {% endfor %}
        </ul>
    </div>

    {% if task.filter_mode != 'none' and task.filter_columns %}
    <div class="detail-card">
        <h3>è¿‡æ»¤åˆ—åˆ—è¡¨</h3>
        <ul class="file-list">
            {% for col in task.filter_columns %}
            <li>{{ col }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% if task.column_rule %}
    <div class="detail-card">
        <h3>åˆ—æ´¾ç”Ÿè§„åˆ™</h3>
        <div class="detail-item">
            <span class="label">æºåˆ—:</span>
            <span>{{ task.column_rule.source_column }}</span>
        </div>
        <div class="detail-item">
            <span class="label">æ–°åˆ—:</span>
            <span>{{ task.column_rule.new_column }}</span>
        </div>
        {% if task.column_rule.extraction_start %}
        <div class="detail-item">
            <span class="label">æå–èŒƒå›´:</span>
            <span>{{ task.column_rule.extraction_start }} - {{ task.column_rule.extraction_end }}</span>
        </div>
        {% endif %}
        <div class="detail-item">
            <span class="label">æ˜ å°„è§„åˆ™:</span>
            <span>{{ task.column_rule.mappings|length }} æ¡</span>
        </div>
    </div>
    {% endif %}

    {% if task.cell_operations.count > 0 %}
    <div class="detail-card">
        <h3>å•å…ƒæ ¼æ“ä½œ ({{ task.cell_operations.count }})</h3>
        <ul class="operation-list">
            {% for op in task.cell_operations.all %}
            <li>
                <strong>{{ op.column }}</strong>: {{ op.get_action_display }}
                {% if op.value %}- {{ op.value }}{% endif %}
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>

<script>
function deleteTask(taskId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä»»åŠ¡å—?åˆ é™¤åæ— æ³•æ¢å¤ã€‚')) {
        return;
    }

    fetch(`/api/tasks/${taskId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('ä»»åŠ¡å·²åˆ é™¤');
            window.location.href = '/tasks/';
        } else {
            alert('åˆ é™¤å¤±è´¥: ' + data.error);
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
