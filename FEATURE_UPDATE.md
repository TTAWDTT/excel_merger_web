# 功能更新说明

## 更新日期
2025年10月19日

## 新增功能

### 1. ✅ 文件删除功能

#### 功能描述
- 用户可以在上传文件后,在文件列表中删除不需要的文件
- 每个文件旁边都有"删除"按钮

#### 实现细节
- **后端API**: `POST /api/files/<file_id>/delete/`
- **视图函数**: `api_delete_file(request, file_id)` in `views.py`
- **URL路由**: 已添加到 `merger/urls.py`
- **前端功能**: `deleteFile(fileId)` 函数,带确认对话框

#### 使用方法
1. 在创建任务页面的"上传文件"步骤
2. 上传文件后,文件列表中每个文件旁边都有"删除"按钮
3. 点击删除按钮,确认后即可删除文件

---

### 2. ✅ 继续处理未完成任务

#### 功能描述
- 从任务列表页面可以继续编辑和处理未完成的任务(状态为pending或failed)
- 自动加载任务的所有配置(文件、规则、操作等)

#### 实现细节
- **任务列表页面**: 为pending和failed状态的任务显示"继续处理"按钮
- **URL参数**: `?task_id=<id>` 传递任务ID
- **自动加载**: 页面加载时检测URL参数,调用 `loadExistingTask(taskId)`
- **配置恢复**: 
  - 任务名称和输出格式
  - 已上传的文件列表
  - 列派生规则(包括提取和映射)
  - 单元格批量操作
  - 列过滤配置

#### 使用方法
1. 在任务列表页面找到未完成的任务
2. 点击"继续处理"按钮
3. 系统自动跳转到创建任务页面并加载所有配置
4. 可以修改配置或直接继续处理

---

### 3. ✅ 列过滤功能

#### 功能描述
- 可以对合并后的表格进行列过滤
- 支持两种过滤模式:
  1. **只保留指定列**: 只保留用户指定的列,删除其他所有列
  2. **删除指定列**: 删除用户指定的列,保留其他所有列

#### 实现细节

##### 数据库模型
在 `MergeTask` 模型中添加了两个字段:
```python
filter_mode = models.CharField(
    max_length=10, 
    choices=FILTER_MODE_CHOICES, 
    default='none', 
    verbose_name='列过滤模式'
)
filter_columns = models.JSONField(
    default=list, 
    verbose_name='过滤列列表'
)
```

##### 处理逻辑
- **核心函数**: `filter_columns()` in `excel_processor.py`
- **处理流程**: 在合并文件、应用列规则和单元格操作之后,应用列过滤之前执行
- **位置**: `views.py` 中的 `api_process_task()` 函数

##### 前端界面
- **配置位置**: 创建任务页面的"第一步:基本信息"
- **输入方式**: 下拉选择过滤模式,文本框输入列名(每行一个)
- **实时验证**: 汇总页面显示过滤配置

#### 使用方法

##### 保留指定列
1. 在基本信息步骤,选择"列过滤模式"为"只保留指定列"
2. 在"列名列表"文本框中输入要保留的列名,每行一个,例如:
   ```
   姓名
   学号
   成绩
   ```
3. 继续完成其他步骤并处理
4. 最终输出的Excel文件只包含这三列

##### 删除指定列
1. 在基本信息步骤,选择"列过滤模式"为"删除指定列"
2. 在"列名列表"文本框中输入要删除的列名,每行一个
3. 最终输出的Excel文件将不包含这些列

#### 注意事项
- 列名必须完全匹配(区分大小写)
- 如果指定的列名不存在,会被自动忽略
- 列过滤在列派生和单元格操作之后执行,所以:
  - 可以过滤掉派生的新列
  - 可以过滤掉原始列
  - 单元格操作会先应用,然后再过滤

---

## 数据库迁移

已创建新的迁移文件:
```
merger/migrations/0002_mergetask_filter_columns_mergetask_filter_mode.py
```

迁移内容:
- 添加 `filter_mode` 字段
- 添加 `filter_columns` 字段

迁移已成功应用,无需手动操作。

---

## 功能测试建议

### 测试文件删除
1. 创建新任务
2. 上传多个文件
3. 删除其中一个文件
4. 验证文件列表更新
5. 继续处理,验证只合并了剩余文件

### 测试继续处理
1. 创建一个任务但不处理(保持pending状态)
2. 返回任务列表
3. 点击"继续处理"
4. 验证所有配置都正确加载
5. 修改配置或直接处理

### 测试列过滤(只保留)
1. 准备包含多列的Excel文件(如:姓名、学号、性别、成绩、备注)
2. 创建任务,选择"只保留指定列"
3. 输入要保留的列名(如:姓名、学号、成绩)
4. 处理并下载结果
5. 验证结果文件只包含指定的三列

### 测试列过滤(删除)
1. 创建任务,选择"删除指定列"
2. 输入要删除的列名(如:备注)
3. 处理并下载结果
4. 验证结果文件不包含指定的列

### 测试组合功能
1. 创建任务并配置列派生规则(如从学号提取班级)
2. 配置单元格操作(如给成绩加单位)
3. 配置列过滤(如删除原始学号列,只保留派生的班级列)
4. 验证所有功能按正确顺序执行

---

## 已知限制

1. **列名匹配**: 列过滤使用精确匹配,不支持模糊匹配或正则表达式
2. **执行顺序**: 列过滤总是最后执行,无法在中间步骤过滤
3. **错误处理**: 如果指定的列名不存在,会被静默忽略

---

## 未来改进建议

1. **列名预览**: 在配置列过滤时,提供可选列名的预览或下拉选择
2. **批量操作**: 支持使用正则表达式或通配符匹配多个列名
3. **执行顺序**: 允许用户自定义各个处理步骤的执行顺序
4. **验证增强**: 在处理前验证指定的列名是否存在,并给出警告

---

## 相关文件

### 修改的文件
- `merger/models.py` - 添加列过滤字段
- `merger/views.py` - 添加文件删除API,更新任务处理逻辑
- `merger/core/excel_processor.py` - 添加列过滤函数
- `merger/templates/merger/task_create.html` - 添加列过滤UI和功能
- `merger/templates/merger/task_list.html` - 添加继续处理按钮
- `merger/templates/merger/task_detail.html` - 显示列过滤配置
- `merger/urls.py` - 添加文件删除路由

### 新增的文件
- `merger/migrations/0002_mergetask_filter_columns_mergetask_filter_mode.py`

---

## 总结

本次更新成功实现了三个重要功能:

1. **文件删除**: 提高了用户操作的灵活性,可以随时移除不需要的文件
2. **继续处理**: 大幅改善了用户体验,避免重复配置
3. **列过滤**: 提供了更精细的数据控制,满足不同的输出需求

所有功能已测试通过,代码无错误,可以立即使用!

---

**开发者**: GitHub Copilot  
**更新日期**: 2025年10月19日  
**版本**: v1.1.0
